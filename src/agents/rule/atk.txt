# ===============================
# 自分ターン行動ロジック
# ===============================

""" -------- ドローフェイズ -------- """
フェイズ = "ドローフェイズ"

# 特殊な効果がなければ何もしない



""" -------- スタンバイフェイズ -------- """
フェイズ = "スタンバイフェイズ"

if サイクロン_セット済み and 相手_伏せ枚数 >= 1:
    細かい条件をつけるなら(if 自分_攻撃表示モンスター数 >= 2 or (相手_モンスター数 <= 1 or 相手_モンスターnot"青眼の白龍"):)
        # 相手の伏せ（罠・永続）を事前に除去して安全に展開
        サイクロン_発動
        



""" -------- メインフェイズ① -------- """
フェイズ = "メインフェイズ1"

# --- サイクロンで伏せ除去（攻撃・召喚前） ---
if サイクロン_所持 and 相手_伏せ枚数 >= 1:
    if 自分_攻撃表示モンスター数 >= 1 or 召喚予定 == True:
        (if 相手_モンスター数 <= 1 or 相手_モンスターnot"青眼の白龍":)
        サイクロン_発動

# --- 儀式召喚・特殊召喚の展開 ---
if 高等儀式術_所持 and 手札に("白竜の聖騎士"):
    高等儀式術_発動()
    儀式召喚("白竜の聖騎士")

if 白竜降臨_所持 and 手札に("白竜の聖騎士") and リリース可能レベル合計 >= 4:
    儀式素材候補 = フィールド上モンスター + 手札モンスター
    for モンスター in 儀式素材候補:
        if モンスター == "仮面竜":
            優先度 = 6
        elif モンスター == "アサルトワイバーン":
            優先度 = 5
        elif モンスター_攻撃力(モンスター) <= 1000:
            優先度 = 4
        elif モンスター_種族(モンスター) == "ドラゴン族" and モンスター_通常モンスター(モンスター):
            優先度 = 3
        elif モンスター == "創世の竜騎士" and 手札に("青眼の白龍"):
            優先度 = 2
        else:
            優先度 = 1
        if リリース素材 < 優先度: 
            最高優先度 = 優先度
            リリースモンスター = モンスター
    白竜降臨_発動(リリースモンスターをリリース)
    儀式召喚("白竜の聖騎士")


メイン1で青眼召喚 = False      # メインフェイズ1で即②発動（攻撃せず青眼SS）
メイン2で青眼召喚 = False      # バトル後、メインフェイズ2で②発動
今回は青眼召喚を温存    = False      # 今ターンは②を使わない

#--- 青眼を召喚するか判定開始 ---

# 1) 裏守備除去（①）を最大化したい：まず攻撃 → その後② が本線
if 相手に裏守備がいる:
    if 聖槍を持つ or 月書を持つ:
        メイン2で青眼召喚 = True
    elif MFを踏んでも許容可能:
        メイン2で青眼召喚 = True
    else:
        # ケア札なし・伏せが厚い時は攻撃自重で即②も検討
        if ミラーフォースの危険あり:
            メイン1で青眼召喚 = True
        else:
            メイン2で青眼召喚 = True

# 2) 表側大型のみで伏せが薄い：ダメージ優先 → 殴ってから②
elif 相手に表側大型がいる and not ミラーフォースの危険あり:
    メイン2で青眼召喚 = True

# 3) 伏せが厚くMF/TTどちらも濃厚
elif ミラーフォースの危険あり and 激流葬の危険あり:
    if サイクロンを持つ:
        メイン2で青眼召喚 = True     # 先に伏せを剥がして攻撃→②
    elif 聖槍を持つ:
        メイン2で青眼召喚 = True     # TTが来ても自軍だけ守れる
    else:
        メイン1で青眼召喚 = True     # 盤面維持優先で即青眼

# 4) 方針が「打点重視」：②で出した青眼は攻撃不可→先に攻撃、後で②
elif 方針_打点重視:
    メイン2で青眼召喚 = True

# 5) 方針が「安全重視」：伏せが多い/攻撃が通らないなら早期に青眼で構える
elif 方針_安全重視:
    if ミラーフォースの危険あり or 激流葬の危険あり:
        メイン1で青眼召喚 = True
    else:
        メイン2で青眼召喚 = True

# 6) 特例：激流葬濃厚・ケア札なし → 誘発させたくないので温存
if 激流葬の危険あり and (not 聖槍を持つ) and (not サイクロンを持つ):
    メイン1で青眼召喚 = False
    メイン2で青眼召喚 = False
    今回は青眼召喚を温存 = True

# 聖騎士②効果：リリースして青眼を出す
if フィールドに("白竜の聖騎士") and 効果使用可("白竜の聖騎士") and メイン1で青眼召喚 =True:
    発動_効果2("白竜の聖騎士")
    特殊召喚("青眼の白龍", 位置="攻撃表示")


# --- 蘇生（召喚補助） ---
発動すべき = False
温存すべき = False

# 0) 物理条件
if not 自分_モンスター枠空き:
    発動すべき = False  # そもそも出せない

# 0.5) 全体除去直後は復旧を最優先
if 直前に_全体除去を受けた:
    発動すべき = True
    温存すべき = False

# 1) キルレンジ（このターン決められる見込み）
if こちら_総打点_蘇生込み見込み >= 相手_LP:
    # キル狙いは最優先。死者蘇生はSS1で安全に通りやすい。
    発動すべき = True

# 2) 盤面復旧（こちらが薄く、このままでは負け筋）
elif こちら_盤面が空に近い:
    発動すべき = True

# 3) 受け重視（守りを固めたい）
elif こちら_守りを固めたい:
    発動すべき = True  # 壁や相打ち札を選ぶ（下のティア表と連動）

# 4) 背面が厚く、より良い選択肢がある場合は温存
if 激流葬_警戒 and (not 聖槍_所持) and (not サイクロン_所持):
    # 召喚・SSに反応され全滅しやすい。保護手段が無ければ温存寄り。
    温存すべき = True

# 5) 通常ドラゴン蘇生は銀轟に譲るのが上手い（差し返し性能）
#    → 死者蘇生は「通常ドラゴン以外」を優先したい
if 通常ドラゴンが墓地にいる and 銀轟_セット済み:
    # ここで通常ドラゴンを死者蘇生に使うと、銀轟の差し返し(CLn上)の旨味が減る
    # ＝可能なら通常ドラゴン以外の高価値ターゲットを選ぶ
    pass  # 実際の対象選択で反映

# 6) 他の蘇生札（罠）はサイクロンで不発になり得るが、死者蘇生は即時完結で安全
#    背面が多い時ほど、リビデより死者蘇生の価値が上がる
if 相手_伏せ枚数 >= 1 and 他の蘇生札_セット済み:
    # ここは「死者蘇生を先に切って安全着地」寄り
    発動すべき = True

# 7) 相手墓地の奪取は強力（特にキル圏・受け崩し）
if 相手墓地_高価値あり:
    発動すべき = True  # 優先して相手墓地ターゲットを候補に入れる

# 8) 儀式予定なら「フィールド素材化」の価値アップ（蘇生→場からリリース）
if このターン_儀式予定 and 発動すべき and not 温存すべき:
    # 蘇生対象に「レベルが合う素材」「リソース価値が低い素材」をブースト
    儀式素材向け係数 = 1.2
else:
    儀式素材向け係数 = 1.0

# 9) バトル可否でスコアリング切替（攻め/受け）
if このターン_バトル可能 and 局面 == "攻め":
    打点係数 = 1.2    # 青眼・高打点を上げる
    受け係数 = 1.0
else:
    打点係数 = 1.0
    受け係数 = 1.2    # 仮面竜・ボマー等の防御札を上げる

# 最終判断
if 温存すべき:
    発動すべき = False
if 死者蘇生_所持 and 墓地にモンスターがある:

    # まず発動可否
    if 発動すべき and not 温存すべき:
        # 対象候補をティア順に構築（状況で入替）
        候補 = []

        # Sティア
        if 墓地に("創世の竜騎士"): 候補.append({"名":"創世の竜騎士","基礎ティア":"S","打点":1800,"役割":"展開"})
        if 墓地に("白竜の聖騎士") and デッキor手札に("青眼の白龍"): 候補.append({"名":"白竜の聖騎士","基礎ティア":"S","打点":1900,"役割":"青眼化"})
        if 墓地に("青眼の白龍"): 候補.append({"名":"青眼の白龍","基礎ティア":"S","打点":3000,"役割":"打点"})

        # Aティア
        if 墓地に("アサルトワイバーン"): 候補.append({"名":"アサルトワイバーン","基礎ティア":"A","打点":1800,"役割":"展開"})
        if 墓地に("アレキサンドライドラゴン"): 候補.append({"名":"アレキサンドライドラゴン","基礎ティア":"A","打点":2000,"役割":"打点"})
        if 墓地に("サファイアドラゴン"): 候補.append({"名":"サファイアドラゴン","基礎ティア":"A","打点":1900,"役割":"打点"})
        if 墓地に("ボマー・ドラゴン"): 候補.append({"名":"ボマー・ドラゴン","基礎ティア":"A","打点":1000,"役割":"相打ち"})
        if 墓地に("仮面竜"): 候補.append({"名":"仮面竜","基礎ティア":"A","打点":1400,"役割":"防御"})

        # Bティア
        if 墓地に("コドモドラゴン"): 候補.append({"名":"コドモドラゴン","基礎ティア":"B","打点":100,"役割":"手札展開"})
        if 墓地に("洞窟に潜む竜"): 候補.append({"名":"洞窟に潜む竜","基礎ティア":"B","打点":1300,"役割":"壁"})

        # --- 相手墓地（奪取候補を追加） ---
        if 相手墓地に("青眼の白龍"): 候補.append({"名":"青眼の白龍(相手墓地)","基礎ティア":"S","打点":3000,"役割":"打点"})
        if 相手墓地に("創世の竜騎士"): 候補.append({"名":"創世の竜騎士(相手墓地)","基礎ティア":"S","打点":1800,"役割":"展開"})

        # --- 重み付け（局面・儀式予定・銀轟温存） ---
        for k in 候補:
            重み = 1.0
            # 打点/受け係数
            if k["役割"] == "打点":
                重み *= 打点係数
            if k["役割"] in ["防御","相打ち"]:
                重み *= 受け係数
            # 儀式素材として価値
            if このターン_儀式予定 and k["名"] not in ["青眼の白龍","青眼の白龍(相手墓地)"]:
                重み *= 儀式素材向け係数
            # 銀轟温存（通常ドラゴンの優先度を下げる）
            if 銀轟_セット済み and any(x in k["名"] for x in ["青眼の白龍","アレキサンドライドラゴン","サファイアドラゴン","洞窟に潜む竜"]):
                重み *= 0.8
            k["重み"] = 重み

        # キルレンジなら最終的に打点順（同率は重みで）
        if こちら_総打点_蘇生込み見込み >= 相手_LP:
            候補.sort(key=lambda x: (x["打点"], x["重み"]), reverse=True)
        else:
            候補.sort(key=lambda x: x["重み"], reverse=True)

        対象 = 候補[0] if 候補 else None
        if 対象:
            死者蘇生_発動(対象=対象["名"])


# --- 儀式・サーチ完了後に壺を撃つ ---
if 強欲な壺_所持 and サーチ完了 == True:
    強欲な壺_発動()


# ライトニング・ボルテックス：発動ロジック詳細

# --- 状況フラグ ---
相手_表側数 = 相手_表側モンスター数
相手_総打点   = 相手_表側打点合計
相手_伏せ数   = 相手_伏せ枚数
こちら_手札枚数 = 自分_手札枚数
このターン_バトル可能 = (このターン_コドモドラゴン効果不使用)  # コドモ発動ターンはバトル不可
キル圏内 = (こちら_想定総打点_afterBV >= 相手_LP)           # BV解決後にリーサル？
受け崩し必要 = (相手_総打点 > 自分_LP or 相手_表側に突破不能がいる)

サイクロン_所持 = 所持("サイクロン")
砂塵_所持       = 所持("砂塵の大竜巻")
聖槍_所持       = 所持("禁じられた聖槍")

# 相手の《禁じられた聖槍》ケア（相手ターンにセット済ならCL2で守られる可能性）
相手_聖槍ケア必要 = (相手_伏せ数 >= 1)

# 価値評価：BVは手札-1のディスアド。2体以上割れると概ね±0以上、3体以上で大幅得
破壊見込み枚数 = 相手_表側数
十分な価値 = (破壊見込み枚数 >= 2) or キル圏内 or 受け崩し必要

# --- コスト候補のスコアリング（高いほど捨てやすい） ---
def コスト評価(カード名):
    # 基本
    捨てカード = 0
    # 役に立たない／ダブついた高レベルは優先して捨てる
    if カード名 in ["余剰な通常モンスター","ダブっている儀式体","今不要な儀式魔法"]:
        if 捨てカード <= 5: 捨てカード = 5 
    # 銀龍の轟咆があるなら「通常ドラゴンを落とす」価値↑
    if セット済("銀龍の轟咆") and カード名 in ["青眼の白龍","サファイアドラゴン","アレキサンドライドラゴン","洞窟に潜む竜"]:
        if 捨てカード <= 4: 捨てカード = 4
    # 死者蘇生やリビデがあるなら「強いモンスターを落とす」価値↑
    if (所持("死者蘇生") or セット済("リビングデッドの呼び声")) and カード名 in ["青眼の白龍","創世の竜騎士","白竜の聖騎士"]:
        if 捨てカード <= 3: 捨てカード = 3
    # コドモドラゴンは捨てると効果発動→そのターンはバトル不可になる点に注意
    if カード名 == "コドモドラゴン":
        if このターン_バトル可能 and (キル圏内 or 攻めたい):
            if 捨てカード <= 1: 捨てカード = 1  # 攻めたいターンは極力捨てない
        else:
            if 捨てカード <= 2: 捨てカード = 2  # 受けターン・相手ターン見据えなら許容
    # 重要コンボ札（サイクロン、聖槍、月書、白竜降臨/高等儀式術など）は極力温存
    if カード名 in ["サイクロン","禁じられた聖槍","月の書","白竜降臨","高等儀式術","強欲な壺","銀龍の轟咆"]:
        捨てカード = 0
    return 捨てカード

# --- 発動順（バック除去→BV）が基本 ---
def 先にバックを剥がすべき():
    # 相手の聖槍CL2で守られるのを避けたい／リビデ等の不発化も狙う
    return 相手_聖槍ケア必要 and (サイクロン_所持 or 砂塵_所持)

# --- メイン判定 ---
if 所持("ライトニング・ボルテックス") and 相手_表側数 >= 1:

    # 1) 価値があるか（-1を回収できるか／勝敗に直結するか）
    if not 十分な価値:
        # 1体だけで、かつバトルで踏める／他解決策があるなら温存
        pass
    else:
        # 2) 先にバックを剥がす（相手の聖槍・リビデ等ケア）
        if 先にバックを剥がすべき():
            if サイクロン_所持:
                サイクロン_発動(対象=相手_最重要伏せ)   # CL2で守られる前に処理
            elif 砂塵_所持:
                砂塵の大竜巻_発動(対象=相手_最重要伏せ)

        # 3) コスト選択（このターンのプランと噛み合わせ）
        コスト = 選択_手札コスト()
        if コスト == "コドモドラゴン" and このターン_バトル可能:
            # バトル不可になるので、攻めターンなら再選択
            コスト = 次点のコストを再選択()

        # 4) 発動タイミング：基本は通常召喚の前（TTを撃たせず盤面整理）
        #    ただし相手のリビデ等にチェーンさせてからまとめて流す動きも可
        ライトニングボルテックス_発動(コスト=コスト)

        # 5) 直後のプラン
        #    - 召喚・展開（TTケアで聖槍構え）
        #    - キル圏なら即バトルへ


if 大嵐_所持: #使わない方がいい理由
    if 自分_永続魔罠_稼働中 or 自分_キーカード_保護が必要:
        大嵐_行動 = "温存" # 自分の装備/永続/蘇生リンクを巻き込むため
    elif 自分_サイクロン_所持 and 相手_伏せ枚数 == 1:
        大嵐_行動 = "温存" # 単体除去で十分（サイクロン優先）
    elif 自分_砂塵の大竜巻_所持 and 相手_伏せ枚数 == 1:
        大嵐_行動 = "温存" # 砂塵の大竜巻でピンポイント破壊＋手札セットの利点
    elif 自分_伏せ枚数 >= 2 and not これからバトルに入る予定:
        大嵐_行動 = "温存" # 自分の伏せ被害が大きい

if 大嵐_所持 and 大嵐_行動 == "未決": #使った方がいい理由
    # バトル前の全面掃除（攻撃宣言で噛む罠を事前に排除）
    if これからバトルに入る予定 and (相手_伏せ枚数 >= 1 or 相手_永続魔罠_枚数 >= 1):
        大嵐_行動 = "発動"
        大嵐_理由 = "バトル前の妨害を根こそぎ除去"
    # 相手の蘇生/永続リンクを道連れ破壊できる盤面
    elif 相手_蘇生or永続系_濃厚 or 相手_永続魔罠_枚数 >= 1:
        大嵐_行動 = "発動"
        大嵐_理由 = "相手の永続/蘇生リンクごと初期化"
    # 面で触る必要がある（単体除去が無い or 情報非対称を解消したい）
    elif (相手_伏せ枚数 + 相手_永続魔罠_枚数) >= 2 and not 自分_サイクロン_所持:
        大嵐_行動 = "発動"
        大嵐_理由 = "面的回答で情報非対称を解消"
    # 展開前に通したい魔法があり、相手の妨害が面で残る
    elif 展開前に通したい魔法がある and (相手_伏せ枚数 >= 1 or 相手_永続魔罠_枚数 >= 1):
        大嵐_行動 = "発動"
        大嵐_理由 = "後続のキーマジックを安全着地"

# --- まだ未決なら、代替手での見送り判断 ---
if 大嵐_所持 and 大嵐_行動 == "未決":
    if 自分_月の書_所持 and 相手_ミラフォ等高危険罠_濃厚 and これからバトルに入る予定:
        大嵐_行動 = "温存"
        大嵐_理由 = "月の書でバトルトリック対処可（大嵐はアド源として温存）"
    else:
        大嵐_行動 = "温存"
        大嵐_理由 = "即時の面的価値が薄い/自分被害が読めない"

# --- 実行または代替案メモ ---
if 大嵐_行動 == "発動":
    # 注意：自分の永続/装備/蘇生リンクが残っていないか最終確認
    # 相手のチェーン（蘇生・速攻）で一時的に噛み合っても、最終的に面を更地化できる想定
    大嵐_発動()   # 実際のゲームエンジンに合わせて置換
else:
    # 代替のプレイ提案（実行は任意）
    if 自分_サイクロン_所持 and 相手_伏せ枚数 >= 1:
        # 先に“本命”を単体除去で狙い、読み外し時の被害を最小化
        pass  # サイクロン_発動(狙いのカード)
    elif 自分_砂塵の大竜巻_所持 and 相手_伏せ枚数 == 1:
        pass  # 砂塵の大竜巻_発動(対象) → 手札からセット1
    elif 自分_月の書_所持 and これからバトルに入る予定:
        pass  # バトルで誘って月の書で回避、情報を得てから大嵐を温存


# --- モンスター召喚 ---
TIER1, TIER2, TIER3 = [], [], []

# 1) 儀式関連：欠けピースがあり、NSでサーチ価値が高い時は最上位
if (自分_高等儀式術_所持 or 自分_白竜降臨_所持) and not (手札_青眼の白龍_所持 and 自分_白竜降臨_所持):
    # どちらかが欠けている → 召喚時サーチで揃えに行く
    for x in ["マンジュ・ゴッド", "センジュ・ゴッド", "ソニックバード"]:
        if x in 手札_候補: TIER1.append(x)

# 2) 先攻のとき：総破壊（激流）を踏むリスクあり → 召喚時に即価値を出すカード優先
if 先攻:
    # 召喚成功＝即サーチのリソース獲得は強い
    for x in ["マンジュ・ゴッド", "センジュ・ゴッド", "ソニックバード"]:
        if x in 手札_候補 and x not in TIER1: TIER1.append(x)
    # 次点：盤面に残っても美味しい・後続に繋ぐ札
    if "創世の竜騎士" in 手札_候補:
        # 墓地肥やし→蘇生/轟咆の布石。激流を踏むなら《聖槍》があると安心
        (TIER1 if 自分_聖槍_所持 else TIER2).append("創世の竜騎士")

# 3) 後攻・バトルに入って押し込みたい：高打点バニラで圧を掛ける
if not 先攻 and これからバトル:
    for x in ["アレキサンドライドラゴン", "サファイアドラゴン"]:
        if x in 手札_候補: TIER1.append(x)
    # 激流ケアが無ければ“1体だけ”から入る。聖槍があれば多少強気可
    if "創世の竜騎士" in 手札_候補 and 自分_聖槍_所持:
        TIER1.append("創世の竜騎士")
    elif "創世の竜騎士" in 手札_候補:
        TIER2.append("創世の竜騎士")

# 4) 激流葬ケア：聖槍が無い時は「踏んでも損失が軽い」or「召喚で即アド」持ちから
if 相手_激流葬_ケア and not 自分_聖槍_所持:
    # 召喚時サーチ勢は踏まれても手札+1を確保済み
    for x in ["マンジュ・ゴッド", "センジュ・ゴッド", "ソニックバード"]:
        if x in 手札_候補 and x not in TIER1: TIER1.append(x)
    # バトル破壊前提の《アサルトワイバーン》《仮面竜》《ボマー》は温存寄り
    for x in ["アサルトワイバーン", "仮面竜", "ボマー・ドラゴン", "コドモドラゴン"]:
        if x in 手札_候補: TIER3.append(x)

# 5) 蘇生/轟咆が厚い時：墓地を活かす布石を優先（落とす/残す）
if 自分_蘇生魔法_所持 or 自分_銀龍の轟咆_所持:
    # 戦闘で相手を破壊→自己リリースで大型蘇生の目がある《アサルトワイバーン》を評価
    if "アサルトワイバーン" in 手札_候補 and "アレキサンドライドラゴン" in 手札_候補:
        # 先に高打点バニラで盤面制圧→次のターンにワイバーン…でも良いのでTIER2
        TIER2.append("アサルトワイバーン")
    # 《創世の竜騎士》で青眼等を墓地へ → 蘇生/轟咆ラインが立つ
    if "創世の竜騎士" in 手札_候補 and "創世の竜騎士" not in TIER1 and "創世の竜騎士" not in TIER2:
        TIER2.append("創世の竜騎士")

# 6) 相手バックが薄い（単体除去もある）：素直に打点優先
if (相手_伏せ枚数 == 0 or 自分_単体除去_所持) and not 先攻:
    for x in ["アレキサンドライドラゴン", "サファイアドラゴン"]:
        if x in 手札_候補 and x not in TIER1: TIER1.append(x)

# 7) “温存推奨枠”を明示（この盤面では弱い/噛み合いにくい）
for x in ["仮面竜", "ボマー・ドラゴン", "コドモドラゴン"]:
    if x in 手札_候補 and x not in TIER3:
        # 戦闘破壊誘発 or 送られた時誘発で、先攻/激流環境では弱くなりがち
        TIER3.append(x)

# 8) 抜け漏れをTIER2へ（中立組）
for x in 手札_候補:
    if x not in TIER1 and x not in TIER2 and x not in TIER3:
        TIER2.append(x)

# === 出力例：優先順（T1 → T2 → T3 の順で場と手札に合う最上位を選ぶ） ===
召喚優先リスト = TIER1 + TIER2 + TIER3

if 召喚予定 == True and len(召喚優先リスト) > 0:
    # 1体だけ先に出して相手の罠を踏む/踏まないを確認、追加展開はそれを見てから
    通常召喚(召喚優先リスト[0])

    # 罠ケア：激流には「聖槍」（自分対象）、ミラフォには「月の書」（相手/自分対象で戦闘トリック）
    if 相手_激流葬_ケア and 自分_聖槍_所持:
        # 相手の反応に合わせてチェーンで撃つ前提（ここは“構え”のメモ）
        pass  # 聖槍を構える（激流に合わせてキーモンスターへ）
    if 相手_ミラーフォース_ケア and 自分_月の書_所持 and これからバトル:
        pass  # 月の書を構える（攻撃宣言～ダメステの回避トリック用）


# --- 候補と役割 ---
候補 = []
中核 = set()
囮 = set()
チェーンで強い = set()

# 1) 迎撃罠
if 所持_激流葬 and 相手_モンスター展開濃厚:
    候補.append("激流葬"); 中核.add("激流葬")

if 所持_ミラーフォース and (not 先攻 or 相手_横に並べる傾向):
    候補.append("ミラーフォース"); 中核.add("ミラーフォース")

# 2) バック干渉
if 所持_砂塵の大竜巻 and (相手_伏せ枚数 >= 1 or 相手_バック破壊濃厚):
    候補.append("砂塵の大竜巻"); 囮.add("砂塵の大竜巻")

# 3) 蘇生系
if墓地_有効蘇生ターゲット =墓地_有効蘇生ターゲット  # （可読用ダミー、消してOK）
if 墓地_有効蘇生ターゲット:
    if 所持_戦線復帰:
        候補.append("戦線復帰"); 中核.add("戦線復帰"); チェーンで強い.add("戦線復帰")
    if 所持_リビングデッドの呼び声:
        候補.append("リビングデッドの呼び声"); 中核.add("リビングデッドの呼び声"); チェーンで強い.add("リビングデッドの呼び声")

# 4) 速攻魔法（相手ターン価値が高い時のみ伏せ）
if 所持_サイクロン:
    if 相手_伏せ枚数 >= 1 or not これから展開する:
        候補.append("サイクロン"); 囮.add("サイクロン"); チェーンで強い.add("サイクロン")

if 所持_月の書 and (相手_モンスター展開濃厚 or not 先攻 or 相手_横に並べる傾向):
    候補.append("月の書"); 囮.add("月の書"); チェーンで強い.add("月の書")

if 所持_禁じられた聖槍 and 自分_場に守りたい主力あり:
    候補.append("禁じられた聖槍"); 中核.add("禁じられた聖槍"); チェーンで強い.add("禁じられた聖槍")

# 5) 大嵐/砂塵/サイク想定の配慮
中核_枚数 = len([c for c in 候補 if c in 中核])
囮_枚数 = len([c for c in 候補 if c in 囮])

if 相手_バック破壊濃厚 and 戦術_全伏せ許容:
    # リビデと戦線復帰が同居：全伏せでも、チェーン運用で差を付ける（下の計画参照）
    pass

# 6) 並べ順（思考メモ）
表示順 = []
for n in ["激流葬","ミラーフォース","砂塵の大竜巻","サイクロン","戦線復帰","リビングデッドの呼び声","月の書","禁じられた聖槍"]:
    if n in 候補: 表示順.append(n)

# 7) 全伏せ（許容方針なら）
if 戦術_全伏せ許容:
    for 名称 in 表示順:
        セット(名称)

    # --- チェーン計画（被弾時） ---
    # a) 相手が「大嵐」：
    #    ・まず「戦線復帰」にチェーン → 蘇生は場に残りやすい
    #    ・「リビングデッドの呼び声」は離れると蘇生体が道連れ → 無闇に撃たない
    #    ・「サイクロン/砂塵」で別S/Tを割って等価以上を狙う
    # b) 相手が「砂塵/サイク」：
    #    ・対象が“中核”なら「戦線復帰/月の書/聖槍」等で盤面を確保
    #    ・対象が“囮”ならノーチェーン（相手の-1を誘う）
    # c) バトル/展開：
    #    ・激流は2体目以降まで我慢、ミラフォは横並び最大時

# 8) 全伏せしない微調整（任意）
if 相手_バック破壊濃厚 and 自分_場に守りたい主力あり and 戦術_全伏せ許容:
    # 聖槍は手札保持に切替えも可（主力が立ってからで間に合う）
    pass




""" -------- バトルフェイズ -------- """
フェイズ = "バトルフェイズ"

# 盤面の情報（例）
自分_攻撃モンスター = [m1, m2, m3]      # 各mに .攻撃力 atk, .名前, などがある想定
相手_表側モンスター = [e1, e2]            # 各eに .攻撃力, .名前
相手_裏側モンスター = [f1] or []
自分_アサルトワイバーン_場にあり = any(m.名前=="アサルトワイバーン" for m in 自分_攻撃モンスター)

# キーとなる“守りたい/勝ち筋”モンスターを特定（最大打点や効果持ち）
キーフィニッシャー = None
if len(self:=自分_攻撃モンスター) > 0:
    キーフィニッシャー = sorted(self, key=lambda x: x.攻撃力, reverse=True)[0]

# --- 攻撃順の決定（基本：低ATK→高ATK）。ただし例外条件で切替 ---
攻撃順 = sorted(自分_攻撃モンスター, key=lambda x: x.攻撃力)  # 低→高（囮から）

# 例外A：ワンショット圏内で相手バックが薄い（または皆無）→ 高ATKから
総ダメ期待 = sum(m.攻撃力 for m in 自分_攻撃モンスター if not 相手_表側モンスター and not 相手_裏側モンスター)
if 相手_伏せ枚数 == 0 and (相手_表側モンスター==[] and 相手_裏側モンスター==[]) and 総ダメ期待 >= 相手_ライフ:
    攻撃順 = sorted(自分_攻撃モンスター, key=lambda x: x.攻撃力, reverse=True)  # 早期決着を優先

# 例外B：相手表に《ボマー・ドラゴン》がいる → 価値の低い/蘇生で戻せる駒から当てる
if any(e.名前=="ボマー・ドラゴン" for e in 相手_表側モンスター):
    攻撃順 = sorted(自分_攻撃モンスター, key=lambda x: (x is キーフィニッシャー, x.攻撃力))  # キーは後ろへ

# 例外C：自分の《アサルトワイバーン》で“戦闘破壊を狙える相手”がいる → その相手に当てやすい順序へ
if self and 自分_アサルトワイバーン_場にあり and 相手_表側モンスター:
    # 収縮があれば、ワイバーンが確実に割れる対象を用意してから（もしくは対面を選んで）当てたい
    # → ワイバーンは“中盤以降”に置き、先に他の攻撃で盤面を整理
    攻撃順 = [m for m in 攻撃順 if m.名前!="アサルトワイバーン"] + [m for m in 攻撃順 if m.名前=="アサルトワイバーン"]

# 例外D：相手裏が多く、激流等の踏み抜きより情報優先 → 低ATKから裏面チェック維持（基本通り）


# --- 攻撃ループ（チェーン計画を明文化） ---
for 攻撃者 in 攻撃順:
    攻撃宣言(攻撃者)

    # ミラーフォース対策：小物で宣言→相手が撃てば“キーフィニッシャー”を守る
    if 相手_発動("ミラーフォース"):
        if 所持_禁じられた聖槍 and キーフィニッシャー is not None:
            # ※聖槍は「任意の表側モンスター」を対象可。今攻撃している小物ではなく“守りたい主力”に撃つのが合理的。
            チェーン発動("禁じられた聖槍", 対象=キーフィニッシャー)
        elif 所持_月の書 and キーフィニッシャー is not None:
            # 月書は裏守備にしてミラフォ回避（攻撃表示限定）。次のメイン2で再展開も可。
            チェーン発動("月の書", 対象=キーフィニッシャー)
        # どちらも無い場合：被害最小化のため、小物から宣言しておいた価値が出る

    # ダメステの打ち合い：戦闘勝利が重要な場面だけ“収縮”を温存発動
    # 優先順位：①キルに直結 ②除去したい大型（青眼など） ③《アサルトワイバーン》の戦闘破壊トリガー確保
    if 所持_収縮 and 戦闘中 and (
        (相手_ライフ <= 攻撃者.攻撃力) or
        (相手_攻撃対象 and 相手_攻撃対象.攻撃力 >= 攻撃者.攻撃力) or
        (攻撃者.名前=="アサルトワイバーン")
    ):
        収縮_発動(対象=相手_攻撃対象)  # ※収縮は相手表側モンスターを対象にして“元々の攻撃力”を半減

    # 《ボマー・ドラゴン》対策：倒すなら価値の低い駒で。キーフィニッシャーでの相討ちは避ける
    if 相手_攻撃対象 and 相手_攻撃対象.名前=="ボマー・ドラゴン":
        # ここまでに“収縮で上から踏む” or “月の書で裏にして踏む（※裏でも発動し得る裁定が多いので基本は除去へ回す）”
        pass


""" -------- メインフェイズ② -------- """
# ===== MP2 基本方針 =====
# 1) 先に“このターン中にしか意味が薄い起動”や“次ターンの打点底上げ”を処理
# 2) 次ターンのリーサルに向けた盤面/手札/墓地を整える（蘇生→罠の構え→儀式準備）
# 3) 伏せは“割られ方のプラン”まで設計（囮/中核の混在、チェーンで価値化）

# --- A. 召喚権の使い切り（サーチ/布石が有利なら） ---
if 召喚権_残り:
    # 儀式ピースの整備を最優先（次ターンの青眼展開/白竜の聖騎士ルート確保）
    if 手札_儀式ピース片割れ:
        # 例：マンジュ/センジュ/ソニックバードで欠片をサーチ
        if "マンジュ・ゴッド" in 手札: 通常召喚("マンジュ・ゴッド")  # 儀式モンor儀式魔法のどちらでもOK
        elif "センジュ・ゴッド" in 手札: 通常召喚("センジュ・ゴッド")
        elif "ソニックバード" in 手札: 通常召喚("ソニックバード")
    else:
        # 蘇生や轟咆を見据えて《創世の竜騎士》で墓地肥やし（青眼など）→ 次ターン蘇生で詰め
        if "創世の竜騎士" in 手札:
            通常召喚("創世の竜騎士")  # 次のターンに③や蘇生札と噛み合わせる

# --- B. メイン2での“安全な”展開（今ターン攻撃不可でもOKな展開） ---
# 《白竜の聖騎士》②はこのターンの青眼が攻撃できない→MP2でのSSは“次ターンリーサル準備”に最適
if 自分_フィールド_白竜の聖騎士_存在 and (このターン_白竜の聖騎士で攻撃した or True):
    # 相手妨害が薄い/通す価値が高いなら
    if 手札に("青眼の白龍") or デッキに("青眼の白龍"):
        発動("白竜の聖騎士②")  # 自身リリース→青眼SS（このターン青眼は攻撃不可でもOK：次ターン決めに行く）

# --- C. 蘇生の使い分け（割られ方まで想定） ---
# ・相手ターンで強い：戦線復帰（通常罠‐守備SS）, リビデ（永続‐道連れ注意）
# ・自分ターン完結：死者蘇生/轟咆/埋葬/強化蘇生（ただし永続/装備は大嵐に弱い）
if 自分_墓地_通常ドラゴン有効 and 所持_銀龍の轟咆:
    # 轟咆は“通常モンスター限定＆即時解決＆割られ損が少ない”→MP2で盤面を厚くしてエンド
    発動("銀龍の轟咆", 対象="墓地の通常ドラゴン")

if 自分_墓地_任意ドラゴン有効 and 所持_死者蘇生:
    # フリーチェーンでないが“一発解決”で大嵐に巻き込まれにくい。次ターンの打点/素材を確保
    発動("死者蘇生", 対象="墓地の有効ドラゴン")

# 装備/永続リンクは“大嵐リスク”を見て選択（今すぐ必要なら使う、リスク高いなら罠で構える）
if 自分_墓地_任意ドラゴン有効 and 所持_早すぎた埋葬:
    if not 相手_バック破壊濃厚 or 次ターン_リーサル圏内:
        発動("早すぎた埋葬", 対象="墓地の有効ドラゴン")   # 次ターンキル狙いで押し切る
    else:
        # リスクが高いなら使わず温存（割られたら道連れ）
        pass

if 自分_墓地_任意ドラゴン有効 and 所持_強化蘇生:
    if not 相手_バック破壊濃厚 or 次ターン_リーサル圏内:
        セット("強化蘇生")  # 相手除去にチェーン/エンドに起動で面を維持
    else:
        # ここは“戦線復帰/リビデ”に役割を譲ってよい
        pass

# --- D. 相手バックへの干渉（このターン中に使うか/構えるか） ---
# メイン2で無理に“全面除去”を撃たず、原則は“構える”側へ（次ターンの通しを狙う）
if 所持_砂塵の大竜巻 and (相手_伏せ枚数 >= 1):
    セット("砂塵の大竜巻")  # 相手エンドorスタンバイで撃ち合い勝ちを取りに行く

if 所持_サイクロン and (相手_伏せ枚数 >= 1):
    セット("サイクロン")    # 同上（チェーンで等価以上を狙う）。自ターンで使う予定なら保持

# 大嵐は“次ターンの通し”に使う想定。今は伏せ・蘇生を並べ直して価値を最大化
if 所持_大嵐:
    # ここで撃つのは「今すぐ面を更地にしても価値が出る」例外のみ
    if (相手_伏せ枚数 >= 2) and 次ターン_リーサル圏内 and not 自分_盤面に主力あり:
        発動("大嵐")  # 返しで一気に畳み掛ける準備
    else:
        # 原則温存：自分の永続/装備/罠構えと相性が悪い
        pass

# --- E. 防御・妨害のセット（“全伏せ可”だが割られ方まで設計） ---
# 中核＝激流/ミラフォ/戦線復帰/（状況で）リビデ/聖槍　 囮＝砂塵/サイク/月書
# 1) まず迎撃
if 所持_激流葬 and 相手_モンスター展開濃厚: セット("激流葬")
if 所持_ミラーフォース: セット("ミラーフォース")

# 2) 蘇生罠はターゲット有効時のみ（同時多伏せは可だが役割分担を意識）
if 自分_墓地_任意ドラゴン有効 and 所持_戦線復帰: セット("戦線復帰")
if 自分_墓地_任意ドラゴン有効 and 所持_リビングデッドの呼び声: セット("リビングデッドの呼び声")

# 3) バック干渉は囮/打ち返し用として混ぜる
if 所持_砂塵の大竜巻 and "砂塵の大竜巻"をまだセットしていない: セット("砂塵の大竜巻")
if 所持_サイクロン and "サイクロン"をまだセットしていない: セット("サイクロン")

# 4) 速攻支援（主力保護/戦闘介入）
if 所持_月の書: セット("月の書")
if 所持_禁じられた聖槍 and 自分_盤面に主力あり: セット("禁じられた聖槍")

# 大嵐/砂塵/サイク被弾時のチェーン計画（運用メモ）
#  - 大嵐に対して：戦線復帰→優先してチェーン蘇生（解決後残りやすい）。リビデは道連れ注意。
#  - 単体割りに対して：対象が中核なら月書/聖槍/戦線復帰で盤面を確保。囮に当たったらノーチェーン。

# --- F. 手札調整（過剰カードの抱え直し） ---
# 次ターンに価値が薄い単体除去や、今すぐ使えない儀式片割れは“抱える”  ※MDなら不要ならそのまま
# ここは実装環境に合わせてスキップ可能



""" -------- エンドフェイズ -------- """
フェイズ = "エンドフェイズ"

# ===== 1) まず“発動できないもの”の除外（ルール順守） =====
# 罠：今ターンにセットしたものは発動不可
if 今ターンセット_リビデ:    セット済_リビデ = False
if 今ターンセット_戦線復帰:  セット済_戦線復帰 = False
if 今ターンセット_強化蘇生:  セット済_強化蘇生 = False
# QP魔法：今ターンセットした場合は発動不可（ただし手札からは自分ターンなら可）
if 今ターンセット_銀龍の轟咆: セット済_銀龍の轟咆 = False

# ===== 2) エンドフェイズの“能動SS”は原則控えめ =====
# 理由：相手の《激流葬》をこのタイミングで踏むと総崩れになりやすい
# ただし例外的に“守りの駒が必要/詰め準備が最優先”なら実行

# --- 2A. 盤面の壁が必要（次ターンの被弾が怖い／相手展開濃厚） ---
if 相手_展開濃厚 and 墓地_守備向きモンスター有効:
    # 戦線復帰は通常罠→解決後は場にカードが残らず“大嵐”に強め
    if セット済_戦線復帰:
        戦線復帰_発動(対象=墓地_守備モンスター)  # ※この時点で相手が激流を持っていれば発動され得る

# --- 2B. 次ターンの打点/素材を先に用意しておきたい（リーサル準備） ---
if 次ターン_リーサル圏内 and 墓地_通常ドラゴン有効:
    # 自分ターン中のエンドフェイズなので、手札の《銀龍の轟咆》は発動可（手札から）
    if 所持_銀龍の轟咆:
        銀龍の轟咆_発動(対象=墓地_通常ドラゴン)
    elif セット済_銀龍の轟咆:  # 前の自分ターン以前から伏せてあるなら可
        銀龍の轟咆_発動(対象=墓地_通常ドラゴン)

# --- 2C. “相手バックが薄い”かつ“主力を守れる札が手札にある”なら、リビデ採用も可 ---
if 墓地_有効蘇生対象あり and セット済_リビデ and 相手_伏せ枚数 <= 1:
    # 激流を踏んだ場合に備えて《禁じられた聖槍》を手札で構えると安全度UP
    if 所持_禁じられた聖槍 or not 相手_展開濃厚:
        リビングデッドの呼び声_発動(対象=墓地_優秀モンスター)

# --- 2D. 強化蘇生は“永続リンク”＝大嵐に弱い。能動SSは次ターン直前（スタンバイ等）でよい ---
# どうしても必要なとき以外、エンドでの能動発動は見送り
if セット済_強化蘇生 and 相手_バック破壊濃厚:
    pass  # 温存。相手の除去にチェーンで使う

# --- 2E. 早すぎた埋葬（装備）は大嵐/サイク/砂塵の的。能動は原則見送り ---
if 所持_早すぎた埋葬 and not 次ターン_リーサル圏内:
    pass  # 手札保持。詰めに使うときだけ自ターンで

# ===== 3) 手札上限（6枚）調整：捨てるなら“得する捨て方” =====
if 自分_手札枚数 > 6:
    # ・通常ドラゴンを捨てる → 《銀龍の轟咆》の弾になる
    # ・大型を捨てる → 《死者蘇生/リビデ/強化蘇生》の弾になる（次ターンの詰め札）
    # ・過剰な儀式ピース片割れ → 次ターンサーチで補えるなら切る
    余剰 = 選択_捨て札候補(["通常ドラゴン","大型ドラゴン","過剰ピース"])
    捨てる(余剰)

# ===== 4) 被弾想定の“チェーン計画メモ” =====
# a) 相手エンドサイク/砂塵（こちらの伏せに）：
#    - 対象が「中核」なら：戦線復帰/月の書/聖槍 で盤面を確保（対象ズラしや保護）
#    - 対象が「囮」なら：ノーチェーンで等価交換に留める
# b) 相手がここで「激流葬」を用意していた場合（自分が蘇生に動いた直後）：
#    - 《禁じられた聖槍》を主力にチェーン→主力だけ生存
# c) 相手スタンバイ〜メイン開始時：
#    - こちらの「戦線復帰」「強化蘇生」は“相手除去や展開の表出”に合わせて発動（最大値）

# ===== 5) 何もしない勇気（原則） =====
# ・相手伏せが多い/正体不明 → 能動SSは控え、チェーンで価値化できるカードを温存
# ・大嵐読み → リビデ/強化蘇生/埋葬の“永続/装備リンク”は置かない/貼らない

ターン終了()
