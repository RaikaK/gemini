# ===============================
# 相手ターン行動ロジック
# ===============================

# -------- スタンバイフェイズ --------
フェイズ = "相手スタンバイフェイズ"

# === 1) バック干渉：相手メイン前に“価値が上がるS/T”を刈る =================
# 優先順位： 装備/蘇生リンク（道連れ発生） > フィールド/永続 > 不明伏せ
# 砂塵は「破壊 + 手札から1枚セット」のおまけがあるため、先に使うと展開が繋がる
if 相手_伏せ枚数 >= 1 or 相手_メイン前に割りたい:
    # a) 砂塵の大竜巻（セット済&発動可なら先に検討）
    if セット済_砂塵の大竜巻:
        if 相手_装備カード or 相手_蘇生リンク_有:
            砂塵の大竜巻_発動(対象=相手_最重要S_T)  # 例：早すぎた埋葬/リビデ/強化蘇生など → モンスターも巻き込める
            # 解決後：手札から1枚セット（囮 or 中核を状況で）
            手札から_適切なカードをセット()
        elif 相手_重要永続カード or 相手_表側永続_S_T_有:
            砂塵の大竜巻_発動(対象=相手_重要永続S_T)
            手札から_適切なカードをセット()
        elif 相手_伏せ枚数 >= 1 and 相手_大嵐ケア不要:
            砂塵の大竜巻_発動(対象=相手_不明伏せ_本命読み)
            手札から_適切なカードをセット()

    # b) サイクロン（等価交換を狙う。砂塵を既に使った後の“2枚目”や、砂塵が無い時）
    if セット済_サイクロン:
        if 相手_装備カード or 相手_蘇生リンク_有:
            サイクロン_発動(対象=相手_最重要S_T)  # 道連れで実質+α
        elif 相手_重要永続カード or 相手_表側永続_S_T_有:
            サイクロン_発動(対象=相手_重要永続S_T)
        elif 相手_伏せ枚数 >= 1 and 相手_大嵐ケア不要:
            サイクロン_発動(対象=相手_不明伏せ_本命読み)

# === 2) こちらの永続/装備/蘇生リンクは“基本、ここでは貼らない” =================
# 相手メインでの大嵐/サイク/砂塵の的になるため、能動展開は原則見送り。
# ただし、“今、壁が必要”や“相手の除去にチェーンで価値化できる”なら例外。
if セット済_戦線復帰 and 今すぐ壁が必要:
    戦線復帰_発動(対象=墓地_守備向き)
# リビデ/強化蘇生は“大嵐に弱い”ため、相手の除去やバトル開始の表出を待ってからが基本。
# 銀龍の轟咆（QP）はセットからの発動が必要 → 今ターンにセット済でかつ必要性が高ければ可
if セット済_銀龍の轟咆 and 次の相手メインで押し切られそう:
    銀龍の轟咆_発動(対象=墓地_通常ドラゴン)

# === 3) 先出し妨害の判断（例外的に“先に動いておく”ケース） =====================
# 月の書/聖槍は基本“相手の表出に合わせて”だが、以下は例外で事前使用を検討：
#  - 相手フィールドの永続効果持ちモンスター（※このミラーデッキには少）を一時無力化したい
#  - 自分主力が相手メイン開幕で除去される読みが極端に高い（聖槍で耐性付与）
if 自分_場_主力あり and 自分_手札_禁じられた聖槍_所持 and 相手_今すぐの除去が確実視:
    # ただし先撃ちはリスク高め。基本は“相手の除去にチェーン”でOK。
    pass

# === 4) チェーン合戦の方針メモ（相手がここで動いた場合） ========================
# a) 相手がサイク/砂塵でこちらの伏せを指定：
#    - 対象が中核（激流/ミラフォ/戦線復帰/リビデ等）なら、
#      → 戦線復帰/銀龍/月書/聖槍 など別札で価値化（蘇生 or 守り or 別S/T割り返し）
#    - 対象が囮（サイク/砂塵/月書）なら、ノーチェーンで等価交換に留める
# b) 相手が大嵐を先出し：
#    - まず戦線復帰にチェーンして蘇生（解決後に残りやすい）
#    - リビデ/強化蘇生は道連れリスクが高いので、やむを得ない場合のみ
#    - こちらのサイク/砂塵がまだあれば、別の相手S/Tに当てて等価以上を狙う

# === 5) “何もしない”判断 ============================================================
# ・相手のS/Tが不明で多い → 無闇に当てず、相手メインでの表出（召喚/発動）に合わせて後出し有利を取る
# ・こちらの伏せ/永続が多い → 先に撃つと相手の大嵐が通りやすくなるため、抑制
# ・蘇生系は“受けに回した方が強い”場面が多い → 基本は耐える構え


# -------- メインフェイズ① --------
フェイズ = "相手メインフェイズ1"
# ========== 1) “開始直後”に介入するか（能動バック干渉の窓） ==========
# 目的：メイン開始直後に効いてくる厄介な表側S/Tを刈る（装備/蘇生リンク＞永続）
if セット済_砂塵の大竜巻 or セット済_サイクロン:
    if 相手_装備or蘇生リンク_有:
        # 装備/リビデは破壊で道連れが発生 → ここで刈る価値が最も高い
        if セット済_砂塵の大竜巻:
            砂塵の大竜巻_発動(対象=相手_最重要S_T); 手札から_適切に1枚セット()
        elif セット済_サイクロン:
            サイクロン_発動(対象=相手_最重要S_T)
    elif 相手_永続S_T_有 and not 相手_伏せ枚数 >= 2:
        # 表永続が単体で場の価値を高めるタイプ（フィールド等）なら先に処理
        if セット済_砂塵の大竜巻:
            砂塵の大竜巻_発動(対象=相手_重要永続); 手札から_適切に1枚セット()
        elif セット済_サイクロン:
            サイクロン_発動(対象=相手_重要永続)
    else:
        # 不明伏せには安易に触れず、後出しのチェーン勝ちを狙う
        pass

# ========== 2) 召喚・反転召喚・特殊召喚への対応（激流の“最大値”） ==========
# 原則：1体目は様子見、2体目/要の着地で総取り
if 相手_召喚() or 相手_反転召喚() or 相手_特殊召喚():
    直前_召喚体 = 最後に召喚された()
    相手_場_モンスター枚数 += 1  # （疑似）

    # 2-1) サーチNS（マンジュ/センジュ/ソニバ）は通す → 後続をまとめて
    if 直前_召喚体.名前 in ["マンジュ・ゴッド","センジュ・ゴッド","ソニックバード"]:
        if セット済_激流葬 and (相手_場_モンスター枚数 >= 2 or 相手_この後さらに展開しそう):
            激流葬_発動()  # 2体目/着地もしくは更なる展開表示のタイミングで切る（“最大値”志向）

    # 2-2) 大型着地（青眼/創世/白竜の聖騎士）
    if 直前_召喚体.名前 in ["青眼の白龍","創世の竜騎士","白竜の聖騎士"]:
        if セット済_激流葬:
            if 相手_場_モンスター枚数 >= 2 or 相手_この後さらに展開しそう:
                激流葬_発動()
            else:
                # 1体だけなら温存。バトルはミラフォで取る/月書で捌く
                pass

    # 2-3) 蘇生でSSされた場合（早すぎた/リビデ/戦線/強化）
    if 直前_召喚体.由来 in ["早すぎた埋葬","リビングデッドの呼び声","戦線復帰","強化蘇生"]:
        # 先に(1)で装備/永続を刈れていればそもそも出てこない想定
        if セット済_激流葬 and (相手_場_モンスター枚数 >= 2 or 相手_横並び傾向):
            激流葬_発動()

# ========== 3) 相手の魔法・罠発動への即応（チェーン割り/対象外し） ==========
# 3-1) 装備/永続（“道連れ”が発生するもの）最優先
if 相手_発動("早すぎた埋葬"):
    if セット済_サイクロン: サイクロン_発動(対象="早すぎた埋葬")
    elif セット済_砂塵の大竜巻: 砂塵の大竜巻_発動(対象="早すぎた埋葬")

if 相手_発動("リビングデッドの呼び声"):
    if セット済_サイクロン: サイクロン_発動(対象="リビングデッドの呼び声")
    elif セット済_砂塵の大竜巻: 砂塵の大竜巻_発動(対象="リビングデッドの呼び声")

# 3-2) 強化蘇生（破壊しても蘇生体は残る）→ 後回し/盤面で捌く
if 相手_発動("強化蘇生"):
    pass

# 3-3) 儀式魔法（高等儀式術/白竜降臨）は割っても止まりにくい → 着地後を捌く
if 相手_発動("高等儀式術") or 相手_発動("白竜降臨"):
    # ここでサイク/砂塵は基本撃たない（解決が止まらないケースが多い）
    # → 激流/ミラフォ/月書/聖槍で着地後に最大値
    pass

# 3-4) 対象効果への“的外し”
if 相手_発動("対象効果") and セット済_月の書:
    if 自分_狙われたモンスター and 自分_狙われたモンスター.表側表示:
        月の書_発動(対象=自分_狙われたモンスター)  # 裏化で不発化
# 収縮（速攻）は“相手ターンでもセット済なら可”：戦闘前の破壊効果には無力、バトルで使う想定が主
if 相手_発動("対象効果") and セット済_収縮:
    # このフェイズでは通常使わない。バトルに温存
    pass

# ========== 4) 全体/効果破壊に対する“主力保護” ==========
if 相手_発動("全体破壊効果") and セット済_聖槍 and 自分_場_主力あり:
    禁じられた聖槍_発動(対象=自分_主力モンスター)  # 魔罠耐性付与（ATK-800は許容）

# ========== 5) バックの叩き合い（相手が先に撃ってきた時） ==========
if 相手_発動("サイクロン") or 相手_発動("砂塵の大竜巻") or 相手_発動("大嵐"):
    指定 = 相手が指定したカード() if 相手_発動("サイクロン") or 相手_発動("砂塵の大竜巻") else None

    if 相手_発動("大嵐"):
        # まず面を確保（戦線復帰）。リビデ/強化蘇生は道連れ注意で慎重に
        if セット済_戦線復帰 and 自分_墓地_守備壁_有:
            戦線復帰_発動(対象=墓地_守備モンスター)
        # 等価以上を取りにいく
        if セット済_サイクロン and 相手_永続S_T_有:
            サイクロン_発動(対象=相手_重要永続)
    else:
        # 単体割りに対して
        if 指定 in ["激流葬","ミラーフォース","戦線復帰","リビングデッドの呼び声","強化蘇生"]:
            # 中核を守る/価値化
            if セット済_戦線復帰 and 自分_墓地_守備壁_有:
                戦線復帰_発動(対象=墓地_守備モンスター)
            elif セット済_月の書 and 自分_場_主力あり:
                月の書_発動(対象=自分_主力モンスター)
            elif セット済_サイクロン and 相手_永続S_T_有:
                サイクロン_発動(対象=相手_別の重要S_T)
        else:
            # 囮（サイク/砂塵/月書/聖槍/収縮）ならノーチェーンで等価交換
            pass

# ========== 6) “召喚権の使い切り”を誘う待ち（激流最大化の細則） ==========
# 相手が小型→サーチ→SS（蘇生/儀式/通常召喚追加なし）と動く兆候なら、激流は“もう1体”待つ
if セット済_激流葬 and 相手_この後さらに展開しそう and 相手_場_モンスター枚数 == 1:
    # 待ち：ここで撃たず、2体目/大型着地に合わせる
    pass

# ========== 7) “こちらの能動SS”は基本しない（このフェイズ） ==========
# 相手の除去/召喚/発動に“合わせて”使う。自分からリビデ/強化蘇生/埋葬を貼るのはリスク大。
# ※壁が絶対に必要なら例外的に“戦線復帰”のみ可

# ========== 8) 何もしない（強い選択） ==========
# ・不明伏せが多く後出しの方が有利
# ・激流の最大値がまだ見えない
# ・相手の儀式魔法には触らず、着地後を捌く計画が機能している
pass


# -------- バトルフェイズ --------
# --- スタートステップ：原則は様子見。能動蘇生は控えめ ---
# ただし「直撃で負け」「壁が0」のときのみ、即壁を用意（リプレイ誘発）
if ライフが直撃で危険 and フィールドに壁なし:
    if セット済_戦線復帰 and 自分_墓地_守備壁_有:
        戦線復帰_発動(対象=墓地_守備モンスター)
    elif セット済_銀龍の轟咆 and 自分_墓地_通常ドラゴン有:
        銀龍の轟咆_発動(対象=墓地_通常ドラゴン)
    elif セット済_リビデ and 自分_墓地_守備壁_有:
        リビングデッドの呼び声_発動(対象=墓地_守備モンスター)

# === 攻撃ごとのループ（宣言→(必要なら)ダメステ→戦闘後処理） =====================
for 宣言 in 相手_攻撃宣言列:
    攻撃者 = 宣言.攻撃者
    攻撃対象 = 宣言.攻撃対象  # 直接攻撃なら None
    相手_場_残り攻撃者数 -= 1

    # ---------- 1) 直接攻撃ケア（リプレイ・壁生成） ----------
    if 攻撃対象 is None:
        if セット済_戦線復帰 and 自分_墓地_守備壁_有:
            戦線復帰_発動(対象=墓地_守備モンスター)  # リプレイで直撃回避
        elif セット済_銀龍の轟咆 and 自分_墓地_通常ドラゴン有:
            銀龍の轟咆_発動(対象=墓地_通常ドラゴン)
        elif セット済_リビデ and 自分_墓地_守備壁_有:
            リビングデッドの呼び声_発動(対象=墓地_守備モンスター)

    # ---------- 2) ミラーフォース（攻撃宣言時のみ） ----------
    if セット済_ミラーフォース:
        # まとめ取り：まだ複数残っている、または致命打（高打点）なら即発動
        if 相手_場_残り攻撃者数 >= 1:
            ミラーフォース_発動()
        else:
            if 攻撃者.攻撃力 >= 2500 or 自分_LPが危険圏内:
                ミラーフォース_発動()

    # ---------- 3) 月の書/聖槍の基本原則 ----------
    # ・月の書：攻撃者を裏にして攻撃中断／自分が対象にされた効果の“的外し”
    # ・聖槍：自分主力へ→魔罠耐性付与（ATK-800）。相手へ→-800で数値勝ち。
    # ※ 相手に聖槍→そのモンスターは魔罠を受けない＝ミラフォが効かなくなる点に注意
    if セット済_月の書:
        # 3-1) 攻撃者が致命打（青眼/創世など大型） or 効果持ちで厄介
        if 攻撃者.名前 in ["青眼の白龍","創世の竜騎士","白竜の聖騎士","アサルトワイバーン"] or 攻撃者.攻撃力 >= 2500:
            月の書_発動(対象=攻撃者)  # 攻撃中断・効果封じ
        # 3-2) 直前に“自分モンスターが対象”に取られたなら的外し
        elif 相手_直前発動が_対象効果 and 自分_対象になったモンスター.表側表示:
            月の書_発動(対象=自分_対象になったモンスター)

    if セット済_禁じられた聖槍 and 自分_主力:
        # 相手メイン2での除去に備えて今のうちに耐性付与（攻撃で生き残る前提）
        if この攻撃を受けても自分_主力が場に残る見込み and 次のメイン2で除去が濃厚:
            禁じられた聖槍_発動(対象=自分_主力)
        # 数値勝ちのための-800（※この後にミラフォ予定があるなら撃たない！）
        elif 攻撃対象 is not None and 数値が僅差で負ける:
            禁じられた聖槍_発動(対象=攻撃者)

    # ---------- 4) ダメージステップ（ダメ計前）での“収縮” ----------
    if セット済_収縮 and 攻撃者.表側表示 and 攻撃対象 is not None:
        # 4-1) 主力保護/致命打回避
        if 自分_主力 and 自分_主力がこの戦闘で破壊されそう:
            収縮_発動(対象=攻撃者)
        # 4-2) 数値勝ちを取りに行く（こちらの守備壁でギリギリ負ける→半減で生存）
        elif この戦闘で守備壁が割られると致命的:
            収縮_発動(対象=攻撃者)
        # 4-3) 相討ち回避（こちらが《ボマー・ドラゴン》を残したくない場合など）
        elif 攻撃対象.名前=="ボマー・ドラゴン" and こちらが道連れを避けたい:
            収縮_発動(対象=攻撃者)

    # ---------- 5) 個別対面：細則（宣言時〜ダメステ前のウィンドウを活用） ----------
    # 5-A) vs 青眼の白龍（ATK3000）
    if 攻撃者.名前=="青眼の白龍":
        # 優先：ミラフォ/月書/収縮で“戦闘破壊の回避”。聖槍は自分主力にだけ（相手に撃たない）
        if セット済_ミラーフォース: pass  # 既に上方で処理
        elif セット済_月の書: 月の書_発動(対象=攻撃者)
        elif セット済_収縮: 収縮_発動(対象=攻撃者)
        elif セット済_禁じられた聖槍 and 自分_主力:
            禁じられた聖槍_発動(対象=自分_主力)

    # 5-B) vs 白竜の聖騎士
    # ①：裏側守備に攻撃→ダメステ開始時にその裏側を破壊（表出させずに突破してくる）
    # 対応：攻撃宣言〜ダメステ前に“攻撃者”を月書で裏にして攻撃中断、または壁を追加してリプレイ
    if 攻撃者.名前=="白竜の聖騎士":
        if 攻撃対象 is not None and 攻撃対象.裏側守備表示:
            if セット済_月の書:
                月の書_発動(対象=攻撃者)  # ダメステ開始までに裏に
            elif セット済_戦線復帰 and 自分_墓地_守備壁_有:
                戦線復帰_発動(対象=墓地_守備モンスター)  # リプレイ→ターゲット変更を迫る

    # 5-C) vs アサルトワイバーン
    # ① 戦闘破壊に成功→自身をリリースして手札/墓地からドラゴンをSS
    # 対応：戦闘破壊させない（月書／収縮で阻止）／ミラフォでまとめ取り
    if 攻撃者.名前=="アサルトワイバーン":
        if セット済_月の書:
            月の書_発動(対象=攻撃者)
        elif セット済_収縮:
            収縮_発動(対象=攻撃者)

    # 5-D) vs ボマー・ドラゴン
    # ① このカードの攻撃で発生する戦闘ダメージは0
    # ② 戦闘で破壊され墓地へ→このカードを破壊したモンスターを破壊
    # 対応：小物で受けて相討ち上等（主力を当てない）／数値勝ちでこちらが残るなら収縮で安全取りも可
    if 攻撃者.名前=="ボマー・ドラゴン":
        # 直撃は0ダメ → 無理に止めなくてよい
        if 自分_主力 and 攻撃対象 is 自分_主力:
            # 主力が道連れになるのはNG → 月書/収縮で回避 or 戦線復帰で壁を追加してリプレイ
            if セット済_月の書: 月の書_発動(対象=攻撃者)
            elif セット済_収縮: 収縮_発動(対象=攻撃者)
            elif セット済_戦線復帰 and 自分_墓地_守備壁_有: 戦線復帰_発動(対象=墓地_守備モンスター)

    # 5-E) vs 仮面竜（こちらが防御側で「壊れて得」）
    # ① 戦闘破壊→デッキからATK1500以下のドラゴンをSS
    # 方針：守るより“壊れて得”を選ぶ場面が多い。収縮/聖槍で守らず誘発を取りに行く。
    if 攻撃対象 is not None and 攻撃対象.名前=="仮面竜":
        if この戦闘で破壊されそう:
            # 能動防御はしない → 誘発で次の壁/盤面を確保
            pass

    # 5-F) vs コドモドラゴン（こちらが防御側で「墓地へ送られて得」）
    # ① 墓地へ送られた場合→手札のドラゴンをSS（このターンはBF不可/ドラゴン縛り）
    if 攻撃対象 is not None and 攻撃対象.名前=="コドモドラゴン":
        if この戦闘で墓地へ送られそう and 手札に_ドラゴン():
            # あえて守らず、戦闘後に手札からドラゴンSSで更なる壁/素材を作る
            pass

    # ---------- 6) 戦闘後の誘発・後処理 ----------
    if 自分_この戦闘で墓地へ送られたモンスター == "仮面竜":
        デッキから_ドラゴンSS(条件="ATK<=1500")  # 例：コドモドラゴン/洞窟に潜む竜 等

    if 自分_この戦闘で墓地へ送られたモンスター == "ボマー・ドラゴン":
        破壊(対象=この戦闘でボマーを破壊した相手モンスター)

    if 自分_この戦闘で墓地へ送られたモンスター == "コドモドラゴン":
        if 手札に_ドラゴン():
            特殊召喚(対象=手札_ドラゴン)  # ※このターンはバトル不可（相手ターンなので問題なし）

    # ---------- 7) 次の攻撃に備えての追加壁（致命回避） ----------
    if 次の攻撃が直撃で致命的:
        if セット済_戦線復帰 and 自分_墓地_守備壁_有:
            戦線復帰_発動(対象=墓地_守備モンスター)
        elif セット済_銀龍の轟咆 and 自分_墓地_通常ドラゴン有:
            銀龍の轟咆_発動(対象=墓地_通常ドラゴン)
        elif セット済_リビデ and 自分_墓地_守備壁_有:
            リビングデッドの呼び声_発動(対象=墓地_守備モンスター)

# --- バトルフェイズ終了時：無理に能動蘇生はしない（相手メイン2の除去の的） ---
# ただし“今動かないと負け”のときだけ最小限の壁を追加
if 相手_メイン2での追撃が確実 and ライフが危険:
    if セット済_戦線復帰 and 自分_墓地_守備壁_有:
        戦線復帰_発動(対象=墓地_守備モンスター)

# -------- メインフェイズ② --------
フェイズ = "相手メインフェイズ2"
# --- 基本方針メモ ---
# ・“相手メイン2”は情報がほぼ出尽くし。ここでは
#   ① 装備/蘇生リンクなど“今すぐ壊すと+αが出る表S/T”だけは即座に刈る
#   ② 不明伏せは“次の相手エンド”に砂塵/サイクを当てる計画を立てる（チェーン勝ち狙い）
#   ③ こちらの能動蘇生/永続の貼り付けは原則しない（相手エンド〜自分ターンで最大化）

# === 1) 表の“価値が高いS/T”をこの場で刈る（今なら+α） =========================
if 相手_装備or蘇生リンク_表:
    # 優先：早すぎた埋葬 ＞ リビングデッド（破壊で蘇生体も巻き込める）
    if セット済_サイク:
        サイクロン_発動(対象=相手_最重要S_T)  # 例：早すぎた/リビデ
    elif セット済_砂塵:
        砂塵の大竜巻_発動(対象=相手_最重要S_T)
        手札から_適切なカードをセット()  # 砂塵の“おまけ”で1枚セット（囮/中核を状況で）

elif 相手_表永続S_T_有:
    # 表の永続（フィールド/永続魔法・罠）が単体で強い場合のみこのタイミングで除去
    if セット済_砂塵:
        砂塵の大竜巻_発動(対象=相手_重要永続)
        手札から_適切なカードをセット()
    elif セット済_サイク:
        サイクロン_発動(対象=相手_重要永続)

# === 2) 不明伏せの増加を観測して“次の相手エンド割り”を計画 ======================
次エンド割り予定 = False
相手_いま大量セット = (相手_いまセットした枚数 >= 2)

if (セット済_砂塵 or セット済_サイク):
    # 相手が2枚以上セット → 次の相手エンドで割る（チェーンされにくい）
    if 相手_いま大量セット:
        次エンド割り予定 = True
    # 1枚セットでも“本命読み”が立つなら次エンドで狙う
    elif 相手_いまセットした枚数 == 1 and 相手_その伏せが重要読み:
        次エンド割り予定 = True

# ただし“自分の次ターンに大嵐で総取り”が有効なら、砂塵/サイクは温存
if 自分_次ターン_大嵐_所持 and 相手_伏せ枚数 >= 2:
    次エンド割り予定 = False  # 大嵐優先計画
    # 大嵐を通すために：この相手メイン2では余計に撃たない（情報を与えない）

# === 3) 相手の追加の召喚/蘇生に対する最低限の受け（ここでは“待ち”が基本） ===
# 相手メイン2のモンスター着地に対して、こちらから能動蘇生/永続貼りは基本しない。
# 壁が完全に足りず、次のエンド〜スタンバイで負け筋が見える時のみ最小限で受ける。
if 相手_追加召喚権_未使用 and 相手_これ以上展開しそう:
    # それでも“激流やミラフォ”が次ターンで最大値になるなら温存。
    pass

# === 4) こちらの能動蘇生/永続貼り付けは原則しない（的を作らない） ============
# 例外：今動かないと致命的（返しまでLPが持たない/壁0）
if フィールドに壁が無く_次の相手エンドまで耐えられない:
    if セット済_戦線 and 自分_墓地_守備壁_有:
        戦線復帰_発動(対象=墓地_守備モンスター)  # 以降の攻撃宣言でリプレイ誘発を狙える
    elif セット済_銀龍 and 自分_墓地_通常ドラゴン有:
        銀龍の轟咆_発動(対象=墓地_通常ドラゴン)
    elif セット済_リビデ and 自分_墓地_守備壁_有:
        リビングデッドの呼び声_発動(対象=墓地_守備モンスター)  # ※大嵐に弱い点は理解の上で

# === 5) バックの叩き合い（相手からのサイク/砂塵/大嵐）に対する方針 ============
if 相手_発動("サイクロン") or 相手_発動("砂塵の大竜巻") or 相手_発動("大嵐"):
    対象_こちらS_T = 相手が指定したカード() if 相手_発動("サイクロン") or 相手_発動("砂塵の大竜巻") else None

    if 相手_発動("大嵐"):
        # まず面を確保（戦線復帰）。リビデ/強化蘇生は道連れ注意で慎重に。
        if セット済_戦線 and 自分_墓地_守備壁_有:
            戦線復帰_発動(対象=墓地_守備モンスター)
        # 等価以上を狙って相手の別S/Tへサイク
        if セット済_サイク and 相手_表永続S_T_有:
            サイクロン_発動(対象=相手_重要永続)

    else:
        # 単体割りの指定が“中核”（激流/ミラフォ/戦線/リビデ/強化蘇生）なら価値化
        if 対象_こちらS_T in ["激流葬","ミラーフォース","戦線復帰","リビングデッドの呼び声","強化蘇生"]:
            if セット済_戦線 and 自分_墓地_守備壁_有:
                戦線復帰_発動(対象=墓地_守備モンスター)  # 先に面を作って-1を緩和
            elif セット済_月書 and 自分_主力あり:
                月の書_発動(対象=自分_主力モンスター)    # 次ターンまで主力保護
            elif セット済_サイク and 相手_表永続S_T_有:
                サイクロン_発動(対象=相手_別の重要S_T)
        else:
            # 囮（サイク/砂塵/月書/聖槍）に当たったらノーチェーンで等価交換
            pass

# === 6) 相手が“装備/永続”をこのメイン2で新規発動してきた場合の即応 ==========
if 相手_発動("早すぎた埋葬"):
    if セット済_サイク: サイクロン_発動(対象="早すぎた埋葬")   # 装備破壊→蘇生体道連れ
    elif セット済_砂塵: 砂塵の大竜巻_発動(対象="早すぎた埋葬")

if 相手_発動("リビングデッドの呼び声"):
    if セット済_サイク: サイクロン_発動(対象="リビングデッドの呼び声")  # 永続破壊→道連れ
    elif セット済_砂塵: 砂塵の大竜巻_発動(対象="リビングデッドの呼び声")

if 相手_発動("強化蘇生"):
    # 破壊しても蘇生体は残る → 後回し（盤面で対処／次ターンの大嵐/激流で総取り）
    pass

# 儀式魔法（高等儀式術/白竜降臨）は割っても止まりにくい → 着地後に捌く
if 相手_発動("高等儀式術") or 相手_発動("白竜降臨"):
    pass

# === 7) “次ターンの通し方”の準備（メモ用フラグ） ================================
次ターン_通し方 = None
if 自分_次ターン_大嵐_所持 and 相手_伏せ枚数 >= 2:
    次ターン_通し方 = "大嵐から入る"
elif 次エンド割り予定:
    次ターン_通し方 = "相手エンド砂塵/サイク→自分ターン展開"
else:
    次ターン_通し方 = "自分メイン1でサイク/砂塵→展開"

# === 8) 何もしない（強い選択） ===================================================
# ・不明伏せが増えたが、こちらは次エンド or 次ターンでまとめて触る計画がある
# ・能動蘇生/永続貼りは“相手除去の的”なので回避
pass


# -------- エンドフェイズ --------
フェイズ = "相手エンドフェイズ"

# --- 正規化：このターンにセットした札は発動不可 ---
セット済_砂塵 = セット済("砂塵の大竜巻") and not 今ターンセット("砂塵の大竜巻")
セット済_サイク = セット済("サイクロン") and not 今ターンセット("サイクロン")
セット済_リビデ = セット済("リビングデッドの呼び声") and not 今ターンセット("リビングデッドの呼び声")
セット済_戦線 = セット済("戦線復帰") and not 今ターンセット("戦線復帰")
セット済_強化蘇生 = セット済("強化蘇生") and not 今ターンセット("強化蘇生")
セット済_銀龍 = セット済("銀龍の轟咆") and not 今ターンセット("銀龍の轟咆")  # QP魔法

# --- 盤面・読み（更新して使う） ---
相手_伏せ枚数 >= 0
相手_いまセットした枚数 >= 0          # この相手ターン中に増えた分
相手_装備or蘇生リンク_表 = 相手_場に(["早すぎた埋葬","リビングデッドの呼び声"])
相手_表永続S_T_有 = 相手_場に(["フィールド魔法","永続魔法","永続罠"]) and not 相手_装備or蘇生リンク_表
相手_不明伏せ_本命読み = 推定_最重要伏せ()

自分_墓地_通常ドラゴン有 = True or False
自分_墓地_展開向き有 = True or False     # 例：青眼/アサルトワイバーン等
自分_墓地_守備壁_有 = True or False
自分_主力あり = True or False

次ターン_リーサル圏内 = True or False
次ターン_大嵐_所持 = True or False
次ターン_先に殴れる = True or False     # 返しでテンポを取れる
こちら_伏せが多い = 自分_伏せ枚数 >= 2

# ================= 1) 表の“即壊すと得するS/T”は最優先で破壊 =================
# 価値序列：早すぎた埋葬（装備破壊=道連れ）＞ リビデ（永続破壊=道連れ）＞ その他の表永続
if 相手_装備or蘇生リンク_表:
    if セット済_サイク:
        サイクロン_発動(対象=相手_最重要S_T)  # 例：早すぎた/リビデ
    elif セット済_砂塵:
        砂塵の大竜巻_発動(対象=相手_最重要S_T)
        if 手札に("魔法カード") or 手札に("罠カード"):
            セット(手札から_囮か中核を選択())   # 砂塵の“おまけ”で1枚セット（囮/中核を状況で）

elif 相手_表永続S_T_有:
    # 単体で強い表永続（フィールド等）はここで刈る選択肢
    if セット済_砂塵:
        砂塵の大竜巻_発動(対象=相手_重要永続)
        if 手札に("魔法カード") or 手札に("罠カード"):
            セット(手札から_囮か中核を選択())
    elif セット済_サイク:
        サイクロン_発動(対象=相手_重要永続)

# ================= 2) 不明伏せは“エンドで叩く”が基本（安全に等価以上） ==========
# この相手ターンにセットしたカードは発動不可 → エンドで割ると“ほぼノーチェーン”
if 相手_いまセットした枚数 >= 1 and (セット済_砂塵 or セット済_サイク):
    if セット済_砂塵 and 相手_いまセットした枚数 >= 1:
        砂塵の大竜巻_発動(対象=相手_不明伏せ_本命読み)
        if 手札に("魔法カード") or 手札に("罠カード"):
            セット(手札から_囮か中核を選択())
    elif セット済_サイク:
        サイクロン_発動(対象=相手_不明伏せ_本命読み)

# ただし次ターンの《大嵐》計画が強いなら、このエンドでは敢えて撃たない
if 次ターン_大嵐_所持 and 相手_伏せ枚数 >= 2 and not 相手_装備or蘇生リンク_表:
    # ここは温存して、返しの自分ターンで大嵐を最大化
    pass

# ================= 3) 相手のチェーンに対する“叩き合い方針” =====================
# 相手がここでサイク/砂塵をチェーンしてきた場合の処理
if 相手_発動("サイクロン") or 相手_発動("砂塵の大竜巻"):
    こちら_指定 = 相手が指定したカード()
    # 指定が中核（戦線/リビデ/強化蘇生/ミラフォ/激流等）なら“価値化”
    if こちら_指定 in ["戦線復帰","リビングデッドの呼び声","強化蘇生","ミラーフォース","激流葬"]:
        if セット済_戦線 and 自分_墓地_守備壁_有:
            戦線復帰_発動(対象=墓地_守備モンスター)  # 面を先に作って-1緩和
        elif セット済_サイク and 相手_表永続S_T_有:
            サイクロン_発動(対象=相手_別の重要S_T)
        elif セット済_銀龍 and 自分_墓地_通常ドラゴン有:
            銀龍の轟咆_発動(対象=墓地_通常ドラゴン)  # 次ターン打点を先行確保
    else:
        # 囮（サイク/砂塵/月書/聖槍など）に当たったなら基本ノーチェーン
        pass

# ================= 4) “相手ターン中に展開強化”——やる/やらない基準 =================
# 原則：能動蘇生は的になるので控えめ。やるなら“次ターンの勝ち”直結/壁必須の時だけ。
if 次ターン_リーサル圏内 and 自分_墓地_展開向き有:
    # 一番安全：銀龍（即時解決・リンクなし）＞ 戦線復帰（通常罠）＞ リビデ（永続リンク）
    if セット済_銀龍 and 自分_墓地_通常ドラゴン有:
        銀龍の轟咆_発動(対象=墓地_通常ドラゴン)
    elif セット済_戦線 and 自分_墓地_展開向き有:
        戦線復帰_発動(対象=墓地_展開モンスター)
    elif セット済_リビデ and 自分_墓地_展開向き有 and not 次ターン_大嵐_所持:
        リビングデッドの呼び声_発動(対象=墓地_展開モンスター)  # 大嵐計画がある時は避ける

# 壁が足りず、このままでは返し前に負け筋が濃い場合のみ“守備蘇生”
if こちら_伏せが多い and 次ターン_大嵐_所持:
    # 自分の伏せも巻き込む計画なら、ここでリビデを貼るのは悪手（道連れになる）
    pass
elif 自分_墓地_守備壁_有 and 返し前に直撃で落ちる恐れ:
    if セット済_戦線:
        戦線復帰_発動(対象=墓地_守備モンスター)
    elif セット済_銀龍 and 自分_墓地_通常ドラゴン有:
        銀龍の轟咆_発動(対象=墓地_通常ドラゴン)
    elif セット済_リビデ:
        リビングデッドの呼び声_発動(対象=墓地_守備モンスター)

# ================= 5) “セットのおまけ”で何を置くか（砂塵解決後） ==================
# 優先：囮（サイク/砂塵/月書）を混ぜて、次ターンの相手サイク/砂塵の的を散らす
if 砂塵の大竜巻_いま解決した:
    if 手札に("月の書"): セット("月の書")         # 囮兼、相手除去への的外し要員
    elif 手札に("サイクロン"): セット("サイクロン") # 叩き合い用
    elif 手札に("戦線復帰") and 自分_墓地_有効: セット("戦線復帰")  # 受けが増える
    elif 手札に("リビングデッドの呼び声") and 自分_墓地_有効 and not 次ターン_大嵐_所持:
        セット("リビングデッドの呼び声")