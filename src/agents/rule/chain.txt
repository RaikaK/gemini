# =========================================
# A. 相手カード別：対処関数
# =========================================

def 対処_ミラーフォース():
    主力 = 自分_守りたい主力()
    if 主力 and 聖槍_所持():
        チェーン発動("禁じられた聖槍", 対象=主力)     # CL2：魔罠耐性→MF不発
    elif 主力 and 月書_所持():
        チェーン発動("月の書", 対象=主力)             # CL2：裏にして回避

def 対処_激流葬():
    主力 = 自分_守りたい主力()
    if 主力 and 聖槍_所持():
        チェーン発動("禁じられた聖槍", 対象=主力)     # 主力だけ残す
    elif 銀轟_所持() and 墓地に(["青眼の白龍","アレキサンドライドラゴン","サファイアドラゴン","洞窟に潜む竜"]):
        チェーン発動("銀龍の轟咆", 対象=墓地_最良通常ドラゴン())  # 手数補充

def 対処_サイクロン():
    対象名 = 相手_対象名()
    if 対象名 == "リビングデッドの呼び声":
        if 銀轟_所持() and 墓地に(["青眼の白龍","アレキサンドライドラゴン","サファイアドラゴン","洞窟に潜む竜"]):
            チェーン発動("銀龍の轟咆", 対象=墓地_最良通常ドラゴン())
    elif 対象名 == "強化蘇生":
        pass   # 永続リンク切れ前提 → 基本開かない
    elif 対象名 == "戦線復帰":
        チェーン発動("戦線復帰", 対象="墓地の守備に向く体")  # 通常罠は割られても解決

def 対処_早すぎた埋葬():
    if サイクロン_所持():
        チェーン発動("サイクロン", 対象="早すぎた埋葬")     # 不発化
    elif 砂塵_所持():
        チェーン発動("砂塵の大竜巻", 対象="早すぎた埋葬")
    elif 銀轟_所持() and 墓地に(["青眼の白龍","アレキサンドライドラゴン","サファイアドラゴン","洞窟に潜む竜"]):
        チェーン発動("銀龍の轟咆", 対象=墓地_最良通常ドラゴン())

def 対処_リビングデッドの呼び声():
    if サイクロン_所持():
        チェーン発動("サイクロン", 対象="リビングデッドの呼び声")  # 不発化（本前提）
    elif 砂塵_所持():
        チェーン発動("砂塵の大竜巻", 対象="リビングデッドの呼び声")

def 対処_戦線復帰():
    # 通常罠：割られても解決→基本は受け入れて後で処理
    if ミラフォ_セット() and 攻撃宣言中():
        発動("聖なるバリア －ミラーフォース－")

def 対処_ライトニング・ボルテックス():
    主力 = 自分_守りたい主力()
    if 主力 and 月書_所持():
        チェーン発動("月の書", 対象=主力)             # 裏で生存
    elif 主力 and 聖槍_所持():
        チェーン発動("禁じられた聖槍", 対象=主力)     # 魔罠耐性
    elif 銀轟_所持() and 墓地に(["青眼の白龍","アレキサンドライドラゴン","サファイアドラゴン","洞窟に潜む竜"]):
        チェーン発動("銀龍の轟咆", 対象=墓地_最良通常ドラゴン())

def 対処_月の書():
    対象名 = 相手_対象名()
    if 聖槍_所持():
        チェーン発動("禁じられた聖槍", 対象=対象名)   # 魔罠無効化→月書不発
    elif 月書_所持():
        チェーン発動("月の書", 対象="最良ターゲット") # 位置入替や的外し

def 対処_収縮():
    対象名 = 相手_対象名()
    if 聖槍_所持():
        チェーン発動("禁じられた聖槍", 対象=対象名)   # 他魔罠無効→収縮不発（ATK-800は受ける）
    elif 収縮_所持():
        チェーン発動("収縮", 対象="相手の戦闘関与体")

def 対処_禁じられた聖槍():
    対象名 = 相手_対象名()
    if 月書_所持():
        チェーン発動("月の書", 対象=対象名)          # 裏化で聖槍空振り（解決時表側条件）

def 対処_大嵐():
    # 割れない→“使い切り”優先
    if 銀轟_所持() and 墓地に(["青眼の白龍","アレキサンドライドラゴン","サファイアドラゴン","洞窟に潜む竜"]):
        チェーン発動("銀龍の轟咆", 対象=墓地_最良通常ドラゴン())
    if 砂塵_所持():
        チェーン発動("砂塵の大竜巻", 対象=相手_厄介永続())

def 対処_召喚_特殊召喚_直後():
    if 激流葬_セット():
        発動("激流葬")  # CL1で踏ませる

# =========================================
# B. 蘇生・速効蘇生・通常罠：解決後を見据えた予約対処
# =========================================

def 対処_死者蘇生():
    # 直接割れない → 解決後の「着地」へ備える
    if 激流葬_セット():
        予約トリガ("相手_特殊召喚_成功後_TT", {"使う": True})
    if ミラフォ_セット():
        予約トリガ("相手_攻撃宣言_時_MF", {"使う": True})
    if 月書_所持():
        予約トリガ("相手_特殊召喚_成功後_月書", {"対象": "相手_蘇生体"})

def 対処_銀龍の轟咆():
    # SS2：無効にできない → 着地後に備える
    if ミラフォ_セット():
        予約トリガ("相手_攻撃宣言_時_MF", {"使う": True})
    if 月書_所持():
        予約トリガ("相手_特殊召喚_成功後_月書", {"対象": "相手_蘇生体"})

def 対処_強化蘇生():
    # 本前提：発動にチェーンで破壊→不発（リンク切れ）
    if サイクロン_所持():
        チェーン発動("サイクロン", 対象="強化蘇生")
    elif 砂塵_所持():
        チェーン発動("砂塵の大竜巻", 対象="強化蘇生")
    else:
        if 月書_所持():
            予約トリガ("相手_特殊召喚_成功後_月書", {"対象": "相手_蘇生体"})

def 対処_相手_蘇生体_解決後共通():
    # 着地直後：受けなら月書、攻めなら次ターン処理
    if 月書_所持() and 自分_受け重視():
        チェーン発動("月の書", 対象="相手_蘇生体")
        解除予約("相手_特殊召喚_成功後_月書")
        return
    if 自分_攻め重視():
        解除予約("相手_特殊召喚_成功後_月書")
        return

def 対処_相手_攻撃宣言_時_MF():
    if ミラフォ_セット():
        発動("聖なるバリア －ミラーフォース－")
    解除予約("相手_攻撃宣言_時_MF")

def 対処_相手_特殊召喚_成功後_TT():
    if 激流葬_セット():
        発動("激流葬")
    解除予約("相手_特殊召喚_成功後_TT")

def 対処_戦線復帰_補強():
    # 通常罠→受け入れて解決後に取る
    if not こちら_この後バトルへ入る() and ミラフォ_セット():
        予約トリガ("相手_攻撃宣言_時_MF", {"使う": True})

def 対処_サイクロン_補強_自伏せ破壊():
    対象名 = 相手_対象名()
    if 対象名 == "リビングデッドの呼び声":
        if 戦線復帰_セット() and 相手_フィールドが薄い():
            発動("戦線復帰")
        elif 銀轟_所持() and 墓地に(["青眼の白龍","アレキサンドライドラゴン","サファイアドラゴン","洞窟に潜む竜"]):
            チェーン発動("銀龍の轟咆", 対象=墓地_最良通常ドラゴン())

# =========================================
# C. ダメージステップ：テンプレ（収縮・聖槍・月書）
# =========================================

def ダメステ_基本テンプレ():
    攻撃側 = 現在の戦闘(攻撃側=True)
    防御側 = 現在の戦闘(攻撃側=False)

    if ダメステ中() and not ダメ計算中():
        if 直前に_相手がチェーンした("収縮"):
            if 所持("禁じられた聖槍"):
                チェーン発動("禁じられた聖槍", 対象=攻撃側)   # 相手収縮を無力化
            elif 所持("収縮"):
                チェーン発動("収縮", 対象=防御側)           # 打点勝ち
            elif 所持("月の書"):
                チェーン発動("月の書", 対象=相手_戦闘関与体()) # 戦闘弱体
        if 直前に_相手がチェーンした("禁じられた聖槍") and 所持("月の書"):
            チェーン発動("月の書", 対象=相手_戦闘関与体())     # 聖槍空振り

        if 自分_攻め重視() and (not 直前に_相手がチェーンした("収縮")) and (not 直前に_相手がチェーンした("禁じられた聖槍")):
            if 収縮_所持():
                チェーン発動("収縮", 対象=防御側)
            elif 聖槍_所持():
                チェーン発動("禁じられた聖槍", 対象=攻撃側)

    elif ダメ計算中():
        if 直前に_相手がチェーンした("収縮") and 聖槍_所持():
            チェーン発動("禁じられた聖槍", 対象=攻撃側)       # 位置変更不可帯につき月書は打たない

def ダメステ_勝ち越しテンプレ_こちら後出し():
    if ダメステ中() and not ダメ計算中():
        if 直前に_相手がチェーンした("収縮") and 聖槍_所持():
            チェーン発動("禁じられた聖槍", 対象=現在の戦闘(攻撃側=True))
        elif 直前に_相手がチェーンした("禁じられた聖槍") and 月書_所持():
            チェーン発動("月の書", 対象=相手_戦闘関与体())

# =========================================
# D. こちら能動 → 相手の返し → こちら再返し
# =========================================

def 能動_ライトニングボルテックス_再返しテンプレ():
    if 相手_伏せ枚数() >= 1 and (サイクロン_所持() or 砂塵_所持()):
        if サイクロン_所持():
            サイクロン_発動(対象=相手_最重要伏せ())
        else:
            砂塵の大竜巻_発動(対象=相手_最重要伏せ())

    コスト = 選択_手札コスト()
    if コスト == "コドモドラゴン" and こちら_この後バトルへ入る():
        コスト = 次点のコストを再選択()
    ライトニングボルテックス_発動(コスト=コスト)

    if 相手_月書_聖槍_所持濃厚() and 月書_所持():
        チェーン発動("月の書", 対象="相手_聖槍の対象")

def 能動_大嵐_再返しテンプレ():
    # 自軍永続の温存判断 → 大嵐SS1
    発動("大嵐")
    # 相手がチェーン蘇生しても解決順で最後に一掃 → 解決後に展開で主導権

def 能動_サイクロン_再返しテンプレ():
    サイクロン_発動(対象=相手_最重要伏せ())
    if 直前に_相手がチェーンした("リビングデッドの呼び声") and 銀轟_所持() and 墓地に(["青眼の白龍","アレキサンドライドラゴン","サファイアドラゴン","洞窟に潜む竜"]):
        チェーン発動("銀龍の轟咆", 対象=墓地_最良通常ドラゴン())
    if 直前に_相手がチェーンした("禁じられた聖槍") and 月書_所持():
        チェーン発動("月の書", 対象="相手_聖槍の対象")

def 能動_死者蘇生_再返しテンプレ():
    死者蘇生_発動(対象="最有力")
    # 着地後に相手の月書を受けたら、攻め/受けのプランでカバー（次アクションに繋ぐ）

# =========================================
# E. 儀式（白竜降臨/高等儀式術）進行の逆算対処
# =========================================

def 儀式進行_逆算対処():
    # 1) 前置き：伏せを剥がしてから
    if 相手_伏せ枚数() >= 1 and (サイクロン_所持() or 砂塵_所持()):
        if サイクロン_所持():
            サイクロン_発動(対象=相手_最重要伏せ())
        else:
            砂塵の大竜巻_発動(対象=相手_最重要伏せ())

    # 2) 儀式本体
    if 所持("高等儀式術") and 手札に("白竜の聖騎士"):
        高等儀式術_発動(); 儀式召喚("白竜の聖騎士")
    elif 所持("白竜降臨") and 手札に("白竜の聖騎士"):
        白竜降臨_発動(); 儀式召喚("白竜の聖騎士")

    # 3) 召喚/SS直後のTTに備えて予約（CL2で聖槍）
    if (相手_打点バフの気配() or 相手_伏せ枚数() >= 1) and 聖槍_所持():
        予約トリガ("相手_発動_激流葬_時_聖槍CL2", {"対象":"白竜の聖騎士"})

    # 4) ②の発動タイミングは別途flagロジックに委譲（メイン1/メイン2/温存）
    #    ここでは②解決中の再返しだけ定義
    pass

def 対処_相手_発動_激流葬_時_聖槍CL2(対象:str):
    if 聖槍_所持():
        チェーン発動("禁じられた聖槍", 対象=対象)
    解除予約("相手_発動_激流葬_時_聖槍CL2")
