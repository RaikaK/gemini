<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>面接シミュレーション実験 - WebGUI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            padding: 30px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .progress {
            height: 25px;
            border-radius: 15px;
            background-color: #e9ecef;
        }
        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
        }
        .log-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border: 1px solid #dee2e6;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 5px;
        }
        .log-entry:nth-child(even) {
            background-color: #e9ecef;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-running {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        .status-idle {
            background-color: #6c757d;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .result-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            color: #6c757d;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="main-container">
                    <div class="text-center mb-4">
                        <h1 class="display-4 fw-bold text-primary">
                            <i class="fas fa-microscope"></i> 面接シミュレーション実験
                        </h1>
                        <p class="lead text-muted">AI面接官と学生の対話をリアルタイムで観察</p>
                    </div>

                    <!-- 実験制御パネル -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-play-circle"></i> 実験制御</h5>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="setIndex" class="form-label">データセットインデックス（空欄でランダム）</label>
                                        <input type="number" class="form-control" id="setIndex" placeholder="例: 0, 1, 2...">
                                    </div>
                                    <div class="mb-3">
                                        <label for="numSimulations" class="form-label">シミュレーション回数</label>
                                        <input type="number" class="form-control" id="numSimulations" value="1" min="1" max="50" placeholder="1-50回">
                                        <div class="form-text">複数回実行して統計的な分析を行います</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="interviewerModel" class="form-label">面接官モデル設定</label>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="interviewerModelType" id="apiModel" value="api" checked>
                                            <label class="form-check-label" for="apiModel">
                                                APIモデル (OpenAI GPT)
                                            </label>
                                        </div>
                                        <div id="apiModelSettings" class="ms-4 mb-2">
                                            <select class="form-select form-select-sm" id="apiModelName">
                                                <option value="gpt-4o-mini" selected>GPT-4o Mini (高速・低コスト)</option>
                                                <option value="gpt-4o">GPT-4o (高性能)</option>
                                                <option value="gpt-4">GPT-4 (標準版)</option>
                                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (最低コスト)</option>
                                                <option value="gpt-5">GPT-5</option>
                                            </select>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="interviewerModelType" id="localModel" value="local">
                                            <label class="form-check-label" for="localModel">
                                                ローカルモデル
                                            </label>
                                        </div>
                                        <div id="localModelSettings" class="ms-4 mb-2" style="display: none;">
                                            <select class="form-select form-select-sm" id="localModelName" onchange="updateLocalModelStatus()">
                                                <!-- 主要な日本語対応モデル -->
                                                <option value="meta-llama/Llama-3.1-8B-Instruct" selected>Llama 3.1 8B Instruct (llama3)</option>
                                                <option value="elyza/ELYZA-japanese-Llama-2-7b-instruct">ELYZA Japanese Llama 2 7B Instruct</option>
                                                <option value="tokyotech-llm/Llama-3.1-Swallow-8B-Instruct-v0.5">SWALLOW 8B Instruct</option>
                                                <option value="elyza/Llama-3-ELYZA-JP-8B">Llama 3 ELYZA JP 8B</option>
                                                
                                                <!-- Llama 3シリーズ -->
                                                <option value="meta-llama/Llama-3.1-70B-Instruct">Llama 3.1 70B Instruct (大容量GPU必要)</option>
                                                
                                                <!-- 日本語特化モデル -->
                                                <option value="stabilityai/japanese-stablelm-instruct-gamma-7b">Japanese StableLM Instruct Gamma 7B</option>
                                                <option value="rinna/weblab-10b-instruction-sft">WebLab 10B Instruction SFT</option>
                                                <option value="cyberagent/calm2-7b-chat">CALM2 7B Chat</option>
                                                <option value="cyberagent/calm2-3b-chat">CALM2 3B Chat (軽量)</option>
                                                
                                                <!-- 軽量・高性能モデル -->
                                                <option value="google/gemma-2-9b-it">Gemma 2 9B IT</option>
                                                <option value="TinyLlama/TinyLlama-1.1B-Chat-v1.0">TinyLlama 1.1B Chat (超軽量)</option>
                                                
                                                <!-- その他の高性能モデル -->
                                                <option value="mistralai/Mistral-7B-Instruct-v0.3">Mistral 7B Instruct</option>
                                                <option value="Qwen/Qwen-7B-Chat">Qwen 7B Chat</option>
                                                <option value="microsoft/Phi-3-mini-4k-instruct">Phi-3 Mini 4K Instruct</option>
                                            </select>
                                            <div id="localModelStatus" class="mt-2">
                                                <div class="form-text text-info">
                                                    <i class="fas fa-info-circle"></i> モデル選択時に初回ダウンロードが実行されます
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="interviewFlowType" class="form-label">面接フロー設定</label>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="interviewFlowType" id="fixedFlow" value="fixed" checked>
                                            <label class="form-check-label" for="fixedFlow">
                                                固定フロー（手動設定）
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="interviewFlowType" id="dynamicFlow" value="dynamic">
                                            <label class="form-check-label" for="dynamicFlow">
                                                智的動的フロー（面接官がゴール達成に向けて最適な質問タイプを自動選択、最大10ラウンド）
                                            </label>
                                        </div>
                                        
                                        <div id="fixedFlowSettings" class="mt-3">
                                            <div class="form-text mb-2">面接の流れを設定（0: 全体質問, 1: 個別質問）</div>
                                            <div class="d-flex gap-2 mb-2">
                                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addQuestionType(0)">全体質問追加</button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addQuestionType(1)">個別質問追加</button>
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearInterviewFlow()">クリア</button>
                                            </div>
                                            <div id="interviewFlowDisplay" class="bg-light p-2 rounded">
                                                <span class="badge bg-primary me-1">1</span>
                                            </div>
                                            <input type="hidden" id="interviewFlow" value="1">
                                        </div>
                                    </div>
                                    <button id="startBtn" class="btn btn-primary btn-lg">
                                        <i class="fas fa-rocket"></i> 実験開始
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center mb-3">
                                        <span class="status-indicator" id="statusIndicator"></span>
                                        <span id="statusText">待機中</span>
                                    </div>
                                    <div class="progress mb-3">
                                        <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <div id="currentStep" class="text-muted small"></div>
                                    <div id="simulationProgress" class="mt-2" style="display: none;">
                                        <small class="text-muted">シミュレーション進捗: <span id="currentSimulation">0</span> / <span id="totalSimulations">0</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- タブナビゲーション -->
                    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
                                <i class="fas fa-terminal"></i> リアルタイムログ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" type="button" role="tab">
                                <i class="fas fa-history"></i> 過去の実験結果
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="models-tab" data-bs-toggle="tab" data-bs-target="#models" type="button" role="tab">
                                <i class="fas fa-database"></i> ローカルモデル管理
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="spreadsheet-tab" data-bs-toggle="tab" data-bs-target="#spreadsheet" type="button" role="tab">
                                <i class="fas fa-table"></i> スプレッドシート連携
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="human-interviewer-tab" data-bs-toggle="tab" data-bs-target="#human-interviewer" type="button" role="tab">
                                <i class="fas fa-user-tie"></i> 人間面接官モード
                            </button>
                        </li>

                    </ul>

                    <!-- タブコンテンツ -->
                    <div class="tab-content" id="mainTabsContent">
                        <!-- リアルタイムログ -->
                        <div class="tab-pane fade show active" id="logs" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0"><i class="fas fa-stream"></i> 実験ログ</h6>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="clearLogs()">
                                            <i class="fas fa-trash"></i> クリア
                                        </button>
                                    </div>
                                    <div class="log-container" id="logContainer">
                                        <div class="text-muted text-center">実験を開始すると、ここにログが表示されます...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 過去の実験結果 -->
                        <div class="tab-pane fade" id="results" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0"><i class="fas fa-database"></i> 実験結果一覧</h6>
                                        <button class="btn btn-outline-primary btn-sm" onclick="loadResults()">
                                            <i class="fas fa-sync"></i> 更新
                                        </button>
                                    </div>
                                    <div id="resultsList">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> 読み込み中...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ローカルモデル管理 -->
                        <div class="tab-pane fade" id="models" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0"><i class="fas fa-database"></i> ローカルモデル管理</h6>
                                        <button class="btn btn-outline-primary btn-sm" onclick="loadModelsStatus()">
                                            <i class="fas fa-sync"></i> 更新
                                        </button>
                                    </div>
                                    
                                    <div id="modelsStatus">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> 読み込み中...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- スプレッドシート連携 -->
                        <div class="tab-pane fade" id="spreadsheet" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0"><i class="fas fa-table"></i> スプレッドシート連携</h6>
                                        <button class="btn btn-outline-primary btn-sm" onclick="loadSpreadsheetStatus()">
                                            <i class="fas fa-sync"></i> 更新
                                        </button>
                                    </div>
                                    
                                    <div id="spreadsheetStatus">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> 読み込み中...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 人間面接官モード -->
                        <div class="tab-pane fade" id="human-interviewer" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-user-tie"></i> 人間面接官モード</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>面接セッション設定</h6>
                                            <div class="mb-3">
                                                <label for="humanSetIndex" class="form-label">データセットインデックス（空欄でランダム）</label>
                                                <input type="number" class="form-control" id="humanSetIndex" placeholder="例: 0, 1, 2...">
                                            </div>
                                            <div class="mb-3">
                                                <label for="humanInterviewFlow" class="form-label">面接フロー設定</label>
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="radio" name="humanInterviewFlowType" id="humanFixedFlow" value="fixed" checked>
                                                    <label class="form-check-label" for="humanFixedFlow">
                                                        固定フロー（手動設定）
                                                    </label>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="radio" name="humanInterviewFlowType" id="humanDynamicFlow" value="dynamic">
                                                    <label class="form-check-label" for="humanDynamicFlow">
                                                        智的動的フロー（面接官がゴール達成に向けて最適な質問タイプを自動選択、最大10ラウンド）
                                                    </label>
                                                </div>
                                                
                                                <div id="humanFixedFlowSettings" class="mt-3">
                                                    <div class="form-text mb-2">面接の流れを設定（0: 全体質問, 1: 個別質問）</div>
                                                    <div class="d-flex gap-2 mb-2">
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addHumanQuestionType(0)">全体質問追加</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addHumanQuestionType(1)">個別質問追加</button>
                                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearHumanInterviewFlow()">クリア</button>
                                                    </div>
                                                    <div id="humanInterviewFlowDisplay" class="bg-light p-2 rounded">
                                                        <span class="badge bg-primary me-1">1</span>
                                                    </div>
                                                    <input type="hidden" id="humanInterviewFlow" value="1">
                                                </div>
                                            </div>
                                            <button id="startHumanInterviewBtn" class="btn btn-primary btn-lg">
                                                <i class="fas fa-play"></i> 人間面接を開始
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center mb-3">
                                                <span class="status-indicator" id="humanStatusIndicator"></span>
                                                <span id="humanStatusText">待機中</span>
                                            </div>
                                            <div class="progress mb-3">
                                                <div class="progress-bar" id="humanProgressBar" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <div id="humanCurrentStep" class="text-muted small"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 面接セッション表示エリア -->
                            <div id="humanInterviewSession" class="card" style="display: none;">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-comments"></i> 面接セッション</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div id="humanInterviewLog" class="log-container" style="max-height: 500px;">
                                                <!-- 面接ログがここに表示されます -->
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <h6>候補者情報</h6>
                                            <div id="humanCandidatesInfo">
                                                <!-- 候補者情報がここに表示されます -->
                                            </div>
                                            
                                            <h6 class="mt-3">次の質問</h6>
                                            <div class="mb-3">
                                                <button id="askCommonQuestionBtn" class="btn btn-outline-primary btn-sm w-100 mb-2">
                                                    <i class="fas fa-users"></i> 全体質問を生成
                                                </button>
                                                <button id="askIndividualQuestionBtn" class="btn btn-outline-success btn-sm w-100 mb-2">
                                                    <i class="fas fa-user"></i> 個別質問を生成
                                                </button>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="humanQuestionInput" class="form-label">カスタム質問</label>
                                                <textarea class="form-control" id="humanQuestionInput" rows="3" placeholder="質問を入力してください..."></textarea>
                                                <button id="askCustomQuestionBtn" class="btn btn-outline-secondary btn-sm w-100 mt-2">
                                                    <i class="fas fa-paper-plane"></i> 質問を送信
                                                </button>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <button id="endInterviewBtn" class="btn btn-danger w-100">
                                                    <i class="fas fa-stop"></i> 面接を終了
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 評価結果表示エリア -->
                            <div id="humanEvaluationResults" class="card" style="display: none;">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-chart-line"></i> 評価結果</h6>
                                </div>
                                <div class="card-body">
                                    <div id="humanEvaluationContent">
                                        <!-- 評価結果がここに表示されます -->
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 結果詳細モーダル -->
    <div class="modal fade" id="resultModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">実験結果詳細</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="resultContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let statusUpdateInterval;
        let results = [];
        let interviewFlow = [1]; // デフォルトは個別質問1回
        let humanInterviewFlow = [1]; // 人間面接官用のフロー
        let humanInterviewSession = null; // 人間面接セッション情報

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            loadResults();
            loadModelsStatus();
            loadSpreadsheetStatus();
            updateLocalModelStatus(); // ローカルモデル状態を初期化
            initializeHumanInterviewer(); // 人間面接官モードの初期化
            statusUpdateInterval = setInterval(updateStatus, 1000);
        });

        // 実験開始
        document.getElementById('startBtn').addEventListener('click', function() {
            const setIndex = document.getElementById('setIndex').value;
            const numSimulations = parseInt(document.getElementById('numSimulations').value);
            const interviewFlowType = document.querySelector('input[name="interviewFlowType"]:checked').value;
            const interviewerModelType = document.querySelector('input[name="interviewerModelType"]:checked').value;
            
            let interviewFlow = null;
            let useDynamicFlow = false;
            let interviewerModelName = null;
            
            if (interviewFlowType === 'fixed') {
                interviewFlow = JSON.parse(document.getElementById('interviewFlow').value);
                useDynamicFlow = false;
            } else if (interviewFlowType === 'dynamic') {
                interviewFlow = null;
                useDynamicFlow = true;
            }
            
            // 面接官モデル設定
            if (interviewerModelType === 'api') {
                interviewerModelName = document.getElementById('apiModelName').value;
            } else if (interviewerModelType === 'local') {
                interviewerModelName = document.getElementById('localModelName').value;
            }
            
            fetch('/api/start_experiment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    set_index: setIndex || null,
                    num_simulations: numSimulations,
                    interview_flow: interviewFlow,
                    use_dynamic_flow: useDynamicFlow,
                    interviewer_model_type: interviewerModelType,
                    interviewer_model_name: interviewerModelName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                } else {
                    alert('実験を開始しました！');
                    document.getElementById('logs-tab').click();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('実験の開始に失敗しました');
            });
        });

        // ステータス更新
        function updateStatus() {
            fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                const progressBar = document.getElementById('progressBar');
                const currentStep = document.getElementById('currentStep');
                const startBtn = document.getElementById('startBtn');

                if (data.is_running) {
                    statusIndicator.className = 'status-indicator status-running';
                    statusText.textContent = '実行中';
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 実行中...';
                    
                    // シミュレーション進捗の表示
                    if (data.total_simulations > 1) {
                        document.getElementById('simulationProgress').style.display = 'block';
                        document.getElementById('currentSimulation').textContent = data.current_simulation;
                        document.getElementById('totalSimulations').textContent = data.total_simulations;
                    }
                } else {
                    statusIndicator.className = 'status-indicator status-idle';
                    statusText.textContent = '待機中';
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-rocket"></i> 実験開始';
                    document.getElementById('simulationProgress').style.display = 'none';
                }

                progressBar.style.width = data.progress + '%';
                progressBar.textContent = data.progress + '%';
                currentStep.textContent = data.current_step;

                // ログの更新
                updateLogs(data.logs);
            })
            .catch(error => {
                console.error('Status update error:', error);
            });
        }

        // ログ更新
        function updateLogs(logs) {
            const logContainer = document.getElementById('logContainer');
            if (logs && logs.length > 0) {
                logContainer.innerHTML = logs.map(log => 
                    `<div class="log-entry">${log}</div>`
                ).join('');
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // ログクリア
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = 
                '<div class="text-muted text-center">実験を開始すると、ここにログが表示されます...</div>';
        }

        // 結果一覧読み込み
        function loadResults() {
            fetch('/api/results')
            .then(response => response.json())
            .then(data => {
                results = data;
                displayResults(data);
            })
            .catch(error => {
                console.error('Results load error:', error);
                document.getElementById('resultsList').innerHTML = 
                    '<div class="text-center text-danger">結果の読み込みに失敗しました</div>';
            });
        }

        // 結果表示
        function displayResults(results) {
            const resultsList = document.getElementById('resultsList');
            
            if (results.length === 0) {
                resultsList.innerHTML = '<div class="text-center text-muted">実験結果がありません</div>';
                return;
            }

            resultsList.innerHTML = results.map(result => {
                let accuracyDisplay = '';
                let typeBadge = '';
                
                if (result.type === 'summary') {
                    typeBadge = '<span class="badge bg-success">サマリー</span>';
                    accuracyDisplay = `
                        <div class="col-md-3">
                            <small class="text-muted">精度指標</small><br>
                            <span class="badge bg-success">正解率: ${(result.overall_accuracy * 100).toFixed(1)}%</span><br>
                            <span class="badge bg-info">F1: ${result.overall_f1_score.toFixed(3)}</span>
                            ${result.knowledge_gaps_available && result.knowledge_gaps_avg_accuracy !== undefined && result.knowledge_gaps_avg_accuracy !== 'N/A' ? `<br><span class="badge bg-warning">評価3: ${(result.knowledge_gaps_avg_accuracy * 100).toFixed(1)}%</span>` : ''}
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">シミュレーション</small><br>
                            <span class="badge bg-warning">${result.total_simulations}回</span><br>
                            <span class="badge bg-success">正解: ${result.correct_predictions}/${result.total_simulations}</span>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">面接官モデル</small><br>
                            <span class="badge bg-secondary">${result.interviewer_type}</span><br>
                            <span class="badge bg-outline-secondary" style="font-size: 0.7em;">${(result.interviewer_model_name || 'N/A').split('/').pop()}</span>
                        </div>
                    `;
                } else {
                    typeBadge = '<span class="badge bg-primary">個別</span>';
                    accuracyDisplay = `
                        <div class="col-md-3">
                            <small class="text-muted">精度指標</small><br>
                            <span class="badge ${result.is_correct ? 'bg-success' : 'bg-danger'}">${result.is_correct ? '正解' : '不正解'}</span><br>
                            <span class="badge bg-info">F1: ${result.f1_score.toFixed(3)}</span>
                            ${result.knowledge_gaps_available && result.knowledge_gaps_accuracy !== undefined && result.knowledge_gaps_accuracy !== 'N/A' ? `<br><span class="badge bg-warning">評価3: ${(result.knowledge_gaps_accuracy * 100).toFixed(1)}%</span>` : ''}
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">候補者数</small><br>
                            <span class="badge bg-info">${result.num_candidates}名</span>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">面接官モデル</small><br>
                            <span class="badge bg-secondary">${result.interviewer_type}</span><br>
                            <span class="badge bg-outline-secondary" style="font-size: 0.7em;">${(result.interviewer_model_name || 'N/A').split('/').pop()}</span>
                        </div>
                    `;
                }
                
                return `
                    <div class="card result-item mb-3" onclick="showResultDetail('${result.filename}')">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    ${typeBadge}<br>
                                    <small class="text-muted">${new Date(result.timestamp).toLocaleString('ja-JP')}</small>
                                </div>
                                                                    <div class="col-md-2">
                                        <small class="text-muted">データセット</small><br>
                                        <span class="badge bg-primary">${result.dataset_name || result.set_index || 'N/A'}</span>
                                    </div>
                                    <div class="col-md-2">
                                        <small class="text-muted">面接回数</small><br>
                                        <span class="badge bg-secondary">${result.total_rounds || 'N/A'}回</span>
                                    </div>
                                ${accuracyDisplay}
                                <div class="col-md-2 text-end">
                                    <i class="fas fa-chevron-right text-muted"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 結果詳細表示
        function showResultDetail(filename) {
            fetch(`/api/results/${filename}`)
            .then(response => response.json())
            .then(data => {
                const content = document.getElementById('resultContent');
                
                // データタイプを判定
                const isSummary = data.experiment_summary !== undefined;
                
                if (isSummary) {
                    // サマリー結果の表示
                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>実験サマリー</h6>
                                <ul class="list-unstyled">
                                    <li><strong>総シミュレーション数:</strong> ${data.experiment_summary.total_simulations}</li>
                                    <li><strong>データセット:</strong> ${data.experiment_summary.set_index !== null ? `Dataset_${data.experiment_summary.set_index + 1}` : 'ランダム選択'}</li>
                                    <li><strong>面接官タイプ:</strong> ${data.experiment_summary.interviewer_type}</li>
                                    <li><strong>面接官モデル:</strong> ${data.experiment_summary.interviewer_model_name || 'N/A'}</li>
                                    <li><strong>面接フロー:</strong> ${data.experiment_summary.interview_flow ? data.experiment_summary.interview_flow.map((type, i) => `${i+1}回目: ${type === 0 ? '全体質問' : '個別質問'}`).join(', ') : 'N/A'}</li>
                                    <li><strong>動的フロー:</strong> ${data.experiment_summary.use_dynamic_flow ? '有効（上記は実際の実行フロー）' : '無効'}</li>
                                    <li><strong>実行時刻:</strong> ${new Date(data.experiment_summary.timestamp).toLocaleString('ja-JP')}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>集計精度指標</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-md-3">
                                                <h4 class="text-success">${(data.aggregated_metrics.overall_accuracy * 100).toFixed(1)}%</h4>
                                                <small>正解率</small>
                                            </div>
                                            <div class="col-md-3">
                                                <h4 class="text-info">${data.aggregated_metrics.overall_f1_score.toFixed(3)}</h4>
                                                <small>F1スコア</small>
                                            </div>
                                            <div class="col-md-3">
                                                <h4 class="text-warning">${data.aggregated_metrics.overall_precision.toFixed(3)}</h4>
                                                <small>Precision</small>
                                            </div>
                                            <div class="col-md-3">
                                                <h4 class="text-primary">${data.aggregated_metrics.overall_recall.toFixed(3)}</h4>
                                                <small>Recall</small>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="text-center">
                                            <h5>正解予測: ${data.aggregated_metrics.correct_predictions}/${data.aggregated_metrics.total_simulations}</h5>
                                            <small class="text-muted">標準偏差: 正解率 ±${data.aggregated_metrics.accuracy_std.toFixed(3)}, F1 ±${data.aggregated_metrics.f1_std.toFixed(3)}</small>
                                        </div>
                                        ${data.aggregated_metrics.token_usage_metrics ? `
                                        <hr>
                                        <h6>Token使用統計</h6>
                                        <div class="row text-center">
                                            <div class="col-md-3">
                                                <h4 class="text-secondary">${data.aggregated_metrics.token_usage_metrics.total_tokens_used.toLocaleString()}</h4>
                                                <small>総Token数</small>
                                            </div>
                                            <div class="col-md-3">
                                                <h4 class="text-secondary">${data.aggregated_metrics.token_usage_metrics.total_api_calls}</h4>
                                                <small>API呼び出し回数</small>
                                            </div>
                                            <div class="col-md-3">
                                                <h4 class="text-secondary">${data.aggregated_metrics.token_usage_metrics.avg_tokens_per_call.toFixed(1)}</h4>
                                                <small>平均Token数/呼び出し</small>
                                            </div>
                                            <div class="col-md-3">
                                                <h4 class="text-secondary">${data.aggregated_metrics.token_usage_metrics.avg_completion_tokens.toFixed(1)}</h4>
                                                <small>平均回答Token数</small>
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="mt-4">個別シミュレーション結果</h6>
                        <div class="accordion" id="individualResultsAccordion">
                            ${data.individual_results.map((result, index) => `
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#individual${index}">
                                            シミュレーション ${result.simulation_num}: ${result.company_profile.name}
                                            <span class="badge ${result.accuracy_metrics.is_correct ? 'bg-success' : 'bg-danger'} ms-2">
                                                ${result.accuracy_metrics.is_correct ? '正解' : '不正解'}
                                            </span>
                                        </button>
                                    </h2>
                                    <div id="individual${index}" class="accordion-collapse collapse" data-bs-parent="#individualResultsAccordion">
                                        <div class="accordion-body">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <h6>精度指標</h6>
                                                    <ul class="list-unstyled">
                                                        <li><strong>評価1 - 正解:</strong> ${result.accuracy_metrics.is_correct ? '✓' : '✗'}</li>
                                                        <li><strong>評価1 - 正解率:</strong> ${(result.accuracy_metrics.accuracy * 100).toFixed(1)}%</li>
                                                        <li><strong>評価1 - F1スコア:</strong> ${result.accuracy_metrics.f1_score.toFixed(3)}</li>
                                                        <li><strong>評価2 - ランキング正解率:</strong> ${result.accuracy_metrics.ranking_accuracy ? (result.accuracy_metrics.ranking_accuracy.accuracy * 100).toFixed(1) + '%' : 'N/A'}</li>
                                                        <li><strong>評価3 - 知識欠損検出:</strong> 
                                                            ${result.accuracy_metrics.knowledge_gaps_metrics && 
                                                              result.accuracy_metrics.knowledge_gaps_metrics.detection_accuracy !== undefined && 
                                                              result.accuracy_metrics.knowledge_gaps_metrics.detection_f1_score !== undefined ? 
                                                                `検出精度: ${(result.accuracy_metrics.knowledge_gaps_metrics.detection_accuracy * 100).toFixed(1)}%, F1: ${result.accuracy_metrics.knowledge_gaps_metrics.detection_f1_score.toFixed(3)}` : 
                                                                'N/A'}
                                                        </li>
                                                        <li><strong>真の志望度最低:</strong> ${result.accuracy_metrics.true_least_motivated.name}</li>
                                                        <li><strong>予測志望度最低:</strong> ${result.accuracy_metrics.predicted_least_motivated}</li>
                                                    </ul>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6>Token使用統計</h6>
                                                    ${(() => {
                                                        let totalTokens = 0;
                                                        let totalCalls = 0;
                                                        let totalPromptTokens = 0;
                                                        let totalCompletionTokens = 0;
                                                        
                                                        result.interview_transcripts.forEach(transcript => {
                                                            transcript.conversation_log.forEach(log => {
                                                                if (log.token_info) {
                                                                    totalTokens += log.token_info.total_tokens || 0;
                                                                    totalPromptTokens += log.token_info.prompt_tokens || 0;
                                                                    totalCompletionTokens += log.token_info.completion_tokens || 0;
                                                                    totalCalls++;
                                                                }
                                                            });
                                                        });
                                                        
                                                        return totalCalls > 0 ? `
                                                        <ul class="list-unstyled">
                                                            <li><strong>総Token数:</strong> ${totalTokens.toLocaleString()}</li>
                                                            <li><strong>API呼び出し回数:</strong> ${totalCalls}</li>
                                                            <li><strong>平均Token数/呼び出し:</strong> ${(totalTokens / totalCalls).toFixed(1)}</li>
                                                            <li><strong>総プロンプトToken数:</strong> ${totalPromptTokens.toLocaleString()}</li>
                                                            <li><strong>総回答Token数:</strong> ${totalCompletionTokens.toLocaleString()}</li>
                                                        </ul>
                                                        ` : '<p class="text-muted">Token情報なし</p>';
                                                    })()}
                                                </div>
                                                                                        <div class="col-md-6">
                                            <h6>最終評価</h6>
                                            <div class="mb-3">
                                                <strong>最も志望度が低い候補者:</strong><br>
                                                <div class="bg-light p-2 rounded">
                                                    ${typeof result.final_evaluations.least_motivated_candidate === 'string' 
                                                        ? result.final_evaluations.least_motivated_candidate 
                                                        : result.final_evaluations.least_motivated_candidate.candidate_name || 'N/A'}
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <strong>候補者ランキング:</strong><br>
                                                <div class="bg-light p-2 rounded small">
                                                    ${typeof result.final_evaluations.motivation_ranking === 'string' 
                                                        ? result.final_evaluations.motivation_ranking 
                                                        : 'ランキングデータなし'}
                                                </div>
                                            </div>
                                        </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${data.individual_results.some(result => result.knowledge_gaps_detailed) ? `
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6>評価3 - 知識欠損検出詳細分析（サマリー）</h6>
                                <div class="accordion" id="knowledgeGapsAccordion">
                                    ${data.individual_results.filter(result => result.knowledge_gaps_detailed).map((result, index) => `
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#kg${index}">
                                                    シミュレーション ${result.simulation_num}: ${result.company_profile.name}
                                                </button>
                                            </h2>
                                            <div id="kg${index}" class="accordion-collapse collapse" data-bs-parent="#knowledgeGapsAccordion">
                                                <div class="accordion-body">
                                                    <h6>LLM定性分析</h6>
                                                    <div class="bg-light p-3 rounded mb-3" style="white-space: pre-wrap; font-family: monospace; font-size: 0.9em;">
                                                        ${result.knowledge_gaps_detailed.llm_qualitative_analysis}
                                                    </div>
                                                    
                                                    <h6>各候補者の定量的性能指標</h6>
                                                    <div class="table-responsive">
                                                        <table class="table table-sm">
                                                            <thead>
                                                                <tr>
                                                                    <th>候補者名</th>
                                                                    <th>Precision</th>
                                                                    <th>Recall</th>
                                                                    <th>F1-Score</th>
                                                                    <th>正しく検出 (TP)</th>
                                                                    <th>誤検出 (FP)</th>
                                                                    <th>見逃し (FN)</th>
                                                                    <th>備考</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                ${Object.entries(result.knowledge_gaps_detailed.quantitative_performance_metrics).map(([candidate_name, metrics]) => `
                                                                    <tr>
                                                                        <td><strong>${candidate_name}</strong></td>
                                                                        <td>${metrics.metrics.precision}</td>
                                                                        <td>${metrics.metrics.recall}</td>
                                                                        <td>${metrics.metrics.f1_score}</td>
                                                                        <td>${metrics.details && metrics.details['correctly_detected (TP)'] ? metrics.details['correctly_detected (TP)'].join(', ') : 'なし'}</td>
                                                                        <td>${metrics.details && metrics.details['incorrectly_detected (FP)'] ? metrics.details['incorrectly_detected (FP)'].join(', ') : 'なし'}</td>
                                                                        <td>${metrics.details && metrics.details['missed (FN)'] ? metrics.details['missed (FN)'].join(', ') : 'なし'}</td>
                                                                        <td>${metrics.note || '-'}</td>
                                                                    </tr>
                                                                `).join('')}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    `;
                } else {
                    // 個別結果の表示
                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>実験情報</h6>
                                <ul class="list-unstyled">
                                    <li><strong>シミュレーション番号:</strong> ${data.simulation_num}</li>
                                    <li><strong>データセット:</strong> ${data.experiment_info.dataset_name || `Dataset_${data.experiment_info.dataset_index + 1}`}</li>
                                    <li><strong>面接官タイプ:</strong> ${data.experiment_info.interviewer_type}</li>
                                    <li><strong>面接官モデル:</strong> ${data.experiment_info.interviewer_model_name || 'N/A'}</li>
                                    <li><strong>面接回数:</strong> ${data.experiment_info.total_rounds}回</li>
                                    <li><strong>面接フロー:</strong> ${data.experiment_info.interview_flow ? data.experiment_info.interview_flow.map((type, i) => `${i+1}回目: ${type === 0 ? '全体質問' : '個別質問'}`).join(', ') : 'N/A'}</li>
                                    <li><strong>動的フロー:</strong> ${data.experiment_info.use_dynamic_flow ? '有効（上記は実際の実行フロー）' : '無効'}</li>
                                    <li><strong>実行時刻:</strong> ${new Date(data.experiment_info.timestamp).toLocaleString('ja-JP')}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>企業情報</h6>
                                <ul class="list-unstyled">
                                    <li><strong>企業名:</strong> ${data.company_profile.name}</li>
                                    <li><strong>業界:</strong> ${data.company_profile.industry}</li>
                                    <li><strong>規模:</strong> ${data.company_profile.size}</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h6>精度指標</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="text-center">
                                            <h3 class="${data.accuracy_metrics.is_correct ? 'text-success' : 'text-danger'}">
                                                ${data.accuracy_metrics.is_correct ? '✓ 正解' : '✗ 不正解'}
                                            </h3>
                                            <div class="row mt-3">
                                                <div class="col-md-3">
                                                    <h5>${(data.accuracy_metrics.accuracy * 100).toFixed(1)}%</h5>
                                                    <small>評価1正解率</small>
                                                </div>
                                                <div class="col-md-3">
                                                    <h5>${data.accuracy_metrics.f1_score.toFixed(3)}</h5>
                                                    <small>F1スコア</small>
                                                </div>
                                                <div class="col-md-3">
                                                    <h5>${data.accuracy_metrics.ranking_accuracy ? (data.accuracy_metrics.ranking_accuracy.accuracy * 100).toFixed(1) + '%' : 'N/A'}</h5>
                                                    <small>評価2ランキング</small>
                                                </div>
                                                <div class="col-md-3">
                                                    <h5>${data.accuracy_metrics.knowledge_gaps_metrics && 
                                                         data.accuracy_metrics.knowledge_gaps_metrics.detection_accuracy !== undefined ? 
                                                        (data.accuracy_metrics.knowledge_gaps_metrics.detection_accuracy * 100).toFixed(1) + '%' : 
                                                        'N/A'}</h5>
                                                    <small>評価3知識欠損</small>
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="text-start">
                                                <p><strong>真の志望度最低:</strong> ${data.accuracy_metrics.true_least_motivated.name} (${data.accuracy_metrics.true_least_motivated.preparation})</p>
                                                <p><strong>予測志望度最低:</strong> ${data.accuracy_metrics.predicted_least_motivated}</p>
                                                ${data.accuracy_metrics.ranking_accuracy ? `
                                                <div class="mt-3">
                                                    <h6>評価2 - ランキング詳細:</h6>
                                                    <div class="table-responsive">
                                                        <table class="table table-sm">
                                                            <thead>
                                                                <tr>
                                                                    <th>順位</th>
                                                                    <th>真のランキング</th>
                                                                    <th>予測ランキング</th>
                                                                    <th>結果</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                ${data.accuracy_metrics.ranking_accuracy.true_ranking.map((item, index) => `
                                                                    <tr>
                                                                        <td>${index + 1}位</td>
                                                                        <td>${item.name} (${item.preparation})</td>
                                                                        <td>${data.accuracy_metrics.ranking_accuracy.predicted_ranking[index] || '不明'}</td>
                                                                        <td><span class="badge ${item.name === data.accuracy_metrics.ranking_accuracy.predicted_ranking[index] ? 'bg-success' : 'bg-danger'}">${item.name === data.accuracy_metrics.ranking_accuracy.predicted_ranking[index] ? '正解' : '不正解'}</span></td>
                                                                    </tr>
                                                                `).join('')}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                ` : ''}
                                                ${data.accuracy_metrics.knowledge_gaps_metrics && 
                                                  data.accuracy_metrics.knowledge_gaps_metrics.detection_accuracy !== undefined && 
                                                  data.accuracy_metrics.knowledge_gaps_metrics.detection_f1_score !== undefined ? `
                                                <div class="mt-3">
                                                    <h6>評価3 - 知識欠損検出詳細:</h6>
                                                    <div class="table-responsive">
                                                        <table class="table table-sm">
                                                            <tbody>
                                                                <tr>
                                                                    <td><strong>検出精度:</strong></td>
                                                                    <td>${(data.accuracy_metrics.knowledge_gaps_metrics.detection_accuracy * 100).toFixed(1)}%</td>
                                                                </tr>
                                                                <tr>
                                                                    <td><strong>検出F1スコア:</strong></td>
                                                                    <td>${data.accuracy_metrics.knowledge_gaps_metrics.detection_f1_score.toFixed(3)}</td>
                                                                </tr>
                                                                <tr>
                                                                    <td><strong>検出された知識欠損数:</strong></td>
                                                                    <td>${data.accuracy_metrics.knowledge_gaps_metrics.detected_gaps_count || 'N/A'}</td>
                                                                </tr>
                                                                <tr>
                                                                    <td><strong>真の知識欠損数:</strong></td>
                                                                    <td>${data.accuracy_metrics.knowledge_gaps_metrics.true_gaps_count || 'N/A'}</td>
                                                                </tr>
                                                                <tr>
                                                                    <td><strong>検出された欠損詳細:</strong></td>
                                                                    <td>${data.accuracy_metrics.knowledge_gaps_metrics.detected_gaps_details || 'N/A'}</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${data.knowledge_gaps_detailed ? `
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h6>評価3 - 知識欠損検出詳細分析</h6>
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>LLM定性分析</h6>
                                            <div class="bg-light p-3 rounded mb-3" style="white-space: pre-wrap; font-family: monospace; font-size: 0.9em;">
                                                ${data.knowledge_gaps_detailed.llm_qualitative_analysis}
                                            </div>
                                            
                                            <h6>各候補者の定量的性能指標</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>候補者名</th>
                                                            <th>Precision</th>
                                                            <th>Recall</th>
                                                            <th>F1-Score</th>
                                                            <th>正しく検出 (TP)</th>
                                                            <th>誤検出 (FP)</th>
                                                            <th>見逃し (FN)</th>
                                                            <th>備考</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${Object.entries(data.knowledge_gaps_detailed.quantitative_performance_metrics).map(([candidate_name, metrics]) => `
                                                            <tr>
                                                                <td><strong>${candidate_name}</strong></td>
                                                                <td>${metrics.metrics.precision}</td>
                                                                <td>${metrics.metrics.recall}</td>
                                                                <td>${metrics.metrics.f1_score}</td>
                                                                <td>${metrics.details && metrics.details['correctly_detected (TP)'] ? metrics.details['correctly_detected (TP)'].join(', ') : 'なし'}</td>
                                                                <td>${metrics.details && metrics.details['incorrectly_detected (FP)'] ? metrics.details['incorrectly_detected (FP)'].join(', ') : 'なし'}</td>
                                                                <td>${metrics.details && metrics.details['missed (FN)'] ? metrics.details['missed (FN)'].join(', ') : 'なし'}</td>
                                                                <td>${metrics.note || '-'}</td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                                                            <div class="col-md-6">
                                    <h6>最終評価</h6>
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>最も志望度が低い候補者</h6>
                                            <div class="bg-light p-2 rounded mb-3">
                                                ${typeof data.final_evaluations.least_motivated_candidate === 'string' 
                                                    ? data.final_evaluations.least_motivated_candidate 
                                                    : data.final_evaluations.least_motivated_candidate.candidate_name || 'N/A'}
                                            </div>
                                            
                                            <h6 class="mt-3">候補者ランキング（志望度が低い順）</h6>
                                            <div class="bg-light p-2 rounded small">
                                                ${typeof data.final_evaluations.motivation_ranking === 'string' 
                                                    ? data.final_evaluations.motivation_ranking 
                                                    : 'ランキングデータなし'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div>
                        
                        <h6 class="mt-4">面接記録</h6>
                        <div class="accordion" id="transcriptAccordion">
                            ${data.interview_transcripts.map((transcript, index) => `
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#transcript${index}">
                                            候補者 ${index + 1}: ${transcript.candidate_info.name}
                                        </button>
                                    </h2>
                                    <div id="transcript${index}" class="accordion-collapse collapse" data-bs-parent="#transcriptAccordion">
                                        <div class="accordion-body">
                                            <div class="mb-3">
                                                <strong>準備レベル:</strong> ${transcript.candidate_info.preparation}<br>
                                                <strong>知識カバレッジ:</strong> ${transcript.knowledge_coverage_info}
                                            </div>
                                            <div class="log-container" style="max-height: 300px;">
                                                ${transcript.conversation_log.map(log => 
                                                    `<div class="log-entry">
                                                        <strong>ラウンド ${log.turn}:</strong><br>
                                                        <strong>質問:</strong> ${log.question}<br>
                                                        <strong>回答:</strong> ${log.answer}
                                                        ${log.token_info ? `<br><small class="text-muted">Token数: ${log.token_info.total_tokens} (プロンプト: ${log.token_info.prompt_tokens}, 回答: ${log.token_info.completion_tokens})</small>` : ''}
                                                    </div>`
                                                ).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                new bootstrap.Modal(document.getElementById('resultModal')).show();
            })
            .catch(error => {
                console.error('Result detail error:', error);
                alert('結果の詳細表示に失敗しました');
            });
        }

        // 面接フロー設定の関数
        function addQuestionType(type) {
            interviewFlow.push(type);
            updateInterviewFlowDisplay();
        }

        function clearInterviewFlow() {
            interviewFlow = [];
            updateInterviewFlowDisplay();
        }

        function updateInterviewFlowDisplay() {
            const display = document.getElementById('interviewFlowDisplay');
            const hiddenInput = document.getElementById('interviewFlow');
            
            display.innerHTML = interviewFlow.map((type, index) => {
                const badgeClass = type === 0 ? 'bg-success' : 'bg-primary';
                const text = type === 0 ? '全体' : '個別';
                return `<span class="badge ${badgeClass} me-1" title="質問${index + 1}">${text}</span>`;
            }).join('');
            
            hiddenInput.value = JSON.stringify(interviewFlow);
        }

        // 面接フロー設定の表示/非表示制御
        document.addEventListener('DOMContentLoaded', function() {
            updateInterviewFlowDisplay();
            
            // 面接フロータイプのラジオボタンの変更イベントを設定
            document.querySelectorAll('input[name="interviewFlowType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const fixedFlowSettings = document.getElementById('fixedFlowSettings');
                    if (this.value === 'fixed') {
                        fixedFlowSettings.style.display = 'block';
                    } else {
                        fixedFlowSettings.style.display = 'none';
                    }
                });
            });
            
            // 面接官モデルタイプのラジオボタンの変更イベントを設定
            document.querySelectorAll('input[name="interviewerModelType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const apiModelSettings = document.getElementById('apiModelSettings');
                    const localModelSettings = document.getElementById('localModelSettings');
                    if (this.value === 'api') {
                        apiModelSettings.style.display = 'block';
                        localModelSettings.style.display = 'none';
                    } else if (this.value === 'local') {
                        apiModelSettings.style.display = 'none';
                        localModelSettings.style.display = 'block';
                    }
                });
            });
        });

        // モデル管理機能
        function loadModelsStatus() {
            fetch('/api/models/status')
            .then(response => response.json())
            .then(data => {
                displayModelsStatus(data);
            })
            .catch(error => {
                console.error('Models status load error:', error);
                document.getElementById('modelsStatus').innerHTML = 
                    '<div class="text-center text-danger">モデル状態の読み込みに失敗しました</div>';
            });
        }

        function displayModelsStatus(data) {
            const modelsStatus = document.getElementById('modelsStatus');
            
            if (data.error) {
                modelsStatus.innerHTML = `<div class="text-center text-danger">エラー: ${data.error}</div>`;
                return;
            }

            let html = '';
            
            // Hugging Face CLI状態
            html += `
                <div class="alert ${data.hf_cli_installed ? 'alert-success' : 'alert-warning'} mb-3">
                    <i class="fas ${data.hf_cli_installed ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
                    Hugging Face CLI: ${data.hf_cli_installed ? 'インストール済み' : '未インストール'}
                </div>
            `;

            // ディスク使用量
            if (data.disk_usage && Object.keys(data.disk_usage).length > 0) {
                let totalSize = 0;
                html += '<h6>ディスク使用量</h6><div class="row mb-3">';
                for (const [modelKey, size] of Object.entries(data.disk_usage)) {
                    const sizeGB = (size / (1024**3)).toFixed(1);
                    totalSize += parseFloat(sizeGB);
                    html += `
                        <div class="col-md-4 mb-2">
                            <div class="card">
                                <div class="card-body p-2">
                                    <small class="text-muted">${modelKey}</small><br>
                                    <strong>${sizeGB}GB</strong>
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += `</div><p class="text-muted">合計: ${totalSize.toFixed(1)}GB</p>`;
            }

            // モデル一覧
            html += '<h6>利用可能なモデル</h6>';
            for (const [modelKey, modelInfo] of Object.entries(data.models)) {
                const statusBadge = modelInfo.downloaded ? 
                    '<span class="badge bg-success">ダウンロード済み</span>' : 
                    '<span class="badge bg-secondary">未ダウンロード</span>';
                
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h6 class="mb-1">${modelKey}</h6>
                                    <p class="text-muted mb-1">${modelInfo.description}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-hdd"></i> ${modelInfo.size_gb}GB | 
                                        <i class="fas fa-microchip"></i> ${modelInfo.recommended_gpu}
                                    </small>
                                </div>
                                <div class="col-md-3">
                                    ${statusBadge}
                                </div>
                                <div class="col-md-3 text-end">
                                    ${modelInfo.downloaded ? 
                                        `<button class="btn btn-outline-danger btn-sm" onclick="cleanupModel('${modelKey}')">
                                            <i class="fas fa-trash"></i> 削除
                                        </button>` :
                                        `<button class="btn btn-primary btn-sm" onclick="downloadModel('${modelKey}')">
                                            <i class="fas fa-download"></i> ダウンロード
                                        </button>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            modelsStatus.innerHTML = html;
        }

        function downloadModel(modelKey) {
            if (!confirm(`モデル ${modelKey} をダウンロードしますか？\n（時間がかかる場合があります）`)) {
                return;
            }

            fetch('/api/models/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ model_key: modelKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                } else {
                    alert(data.message);
                    loadModelsStatus();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ダウンロードに失敗しました');
            });
        }

        function cleanupModel(modelKey) {
            if (!confirm(`モデル ${modelKey} を削除しますか？\n（この操作は取り消せません）`)) {
                return;
            }

            fetch('/api/models/cleanup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ model_key: modelKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                } else {
                    alert(data.message);
                    loadModelsStatus();
                    updateLocalModelStatus(); // ローカルモデル状態も更新
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('削除に失敗しました');
            });
        }

        // ローカルモデル選択時の状態更新
        function updateLocalModelStatus() {
            const selectedModel = document.getElementById('localModelName').value;
            const statusDiv = document.getElementById('localModelStatus');
            
            if (!selectedModel) {
                statusDiv.innerHTML = '<div class="form-text text-info"><i class="fas fa-info-circle"></i> モデルを選択してください</div>';
                return;
            }
            
            // モデルキーを取得
            const modelKey = getModelKeyFromPath(selectedModel);
            if (!modelKey) {
                statusDiv.innerHTML = '<div class="form-text text-warning"><i class="fas fa-exclamation-triangle"></i> 未知のモデルです</div>';
                return;
            }
            
            // モデル状態を取得
            fetch('/api/models/status')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    statusDiv.innerHTML = '<div class="form-text text-danger"><i class="fas fa-exclamation-triangle"></i> 状態取得エラー</div>';
                    return;
                }
                
                const modelInfo = data.models[modelKey];
                if (!modelInfo) {
                    statusDiv.innerHTML = '<div class="form-text text-warning"><i class="fas fa-exclamation-triangle"></i> モデル情報が見つかりません</div>';
                    return;
                }
                
                if (modelInfo.downloaded) {
                    statusDiv.innerHTML = `
                        <div class="form-text text-success">
                            <i class="fas fa-check-circle"></i> ダウンロード済み (${modelInfo.size_gb}GB)
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="form-text text-warning">
                            <i class="fas fa-download"></i> 未ダウンロード (${modelInfo.size_gb}GB) - 実験実行時に自動ダウンロードされます
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Model status error:', error);
                statusDiv.innerHTML = '<div class="form-text text-danger"><i class="fas fa-exclamation-triangle"></i> 状態取得に失敗しました</div>';
            });
        }
        
        // モデルパスからキーを取得するヘルパー関数
        function getModelKeyFromPath(modelPath) {
            const modelMappings = {
                'meta-llama/Llama-3.1-8B-Instruct': 'llama3',
                'elyza/ELYZA-japanese-Llama-2-7b-instruct': 'ELYZA-japanese-Llama-2',
                'tokyotech-llm/Llama-3.1-Swallow-8B-Instruct-v0.5': 'SWALLOW',
                'elyza/Llama-3-ELYZA-JP-8B': 'llama3-elyza-jp',
                'meta-llama/Llama-3.1-70B-Instruct': 'llama3-70b',
                'stabilityai/japanese-stablelm-instruct-gamma-7b': 'japanese-stablelm',
                'rinna/weblab-10b-instruction-sft': 'weblab-10b',
                'cyberagent/calm2-7b-chat': 'calm2-7b',
                'cyberagent/calm2-3b-chat': 'calm2-3b',
                'google/gemma-2-9b-it': 'gemma2-9b',
                'TinyLlama/TinyLlama-1.1B-Chat-v1.0': 'tinyllama',
                'mistralai/Mistral-7B-Instruct-v0.3': 'mistral-7b',
                'Qwen/Qwen-7B-Chat': 'qwen-7b',
                'microsoft/Phi-3-mini-4k-instruct': 'phi-3'
            };
            return modelMappings[modelPath] || null;
        }

        // スプレッドシート連携機能
        function loadSpreadsheetStatus() {
            fetch('/api/spreadsheet/status')
            .then(response => response.json())
            .then(data => {
                displaySpreadsheetStatus(data);
            })
            .catch(error => {
                console.error('Spreadsheet status load error:', error);
                document.getElementById('spreadsheetStatus').innerHTML = 
                    '<div class="text-center text-danger">スプレッドシート状態の読み込みに失敗しました</div>';
            });
        }

        function displaySpreadsheetStatus(data) {
            const spreadsheetStatus = document.getElementById('spreadsheetStatus');
            
            if (!data.enabled) {
                spreadsheetStatus.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> スプレッドシート連携が設定されていません</h6>
                        <p class="mb-2">スプレッドシート連携を使用するには、以下の手順で設定してください：</p>
                        <ol class="mb-3">
                            <li>Google Apps Script エディタで新しいプロジェクトを作成</li>
                            <li><code>gas_spreadsheet_integration.js</code> のコードをコピー&ペースト</li>
                            <li>スプレッドシートのIDを設定</li>
                            <li>デプロイしてWebアプリとして公開</li>
                            <li>WebアプリのURLを <code>spreadsheet_config.json</code> に設定</li>
                        </ol>
                        <div class="text-muted">
                            <small>設定ファイル: <code>spreadsheet_config.json</code></small>
                        </div>
                    </div>
                `;
                return;
            }

            let statusBadge = '';
            let statusMessage = '';
            let actionButtons = '';

            if (data.connected) {
                statusBadge = '<span class="badge bg-success">接続済み</span>';
                statusMessage = data.message;
                
                const stats = data.stats || {};
                actionButtons = `
                    <div class="mt-3">
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="initializeSpreadsheet()">
                            <i class="fas fa-cog"></i> スプレッドシート初期化
                        </button>
                        <button class="btn btn-outline-danger btn-sm me-2" onclick="clearSpreadsheetData()">
                            <i class="fas fa-trash"></i> データクリア
                        </button>
                    </div>
                `;

                if (stats.hasData) {
                    statusMessage += `
                        <div class="mt-2">
                            <small class="text-muted">
                                記録済みデータ: ${stats.totalRows}行 | 
                                シミュレーション: ${Object.entries(stats.simulationNumbers || {}).map(([sim, count]) => `#${sim}(${count}件)`).join(', ')}
                            </small>
                        </div>
                    `;
                }
            } else {
                statusBadge = '<span class="badge bg-danger">接続エラー</span>';
                statusMessage = data.message;
                actionButtons = `
                    <div class="mt-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadSpreadsheetStatus()">
                            <i class="fas fa-sync"></i> 再接続テスト
                        </button>
                    </div>
                `;
            }

            spreadsheetStatus.innerHTML = `
                <div class="alert ${data.connected ? 'alert-success' : 'alert-danger'}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6><i class="fas fa-table"></i> スプレッドシート連携状態</h6>
                            <p class="mb-0">${statusBadge} ${statusMessage}</p>
                        </div>
                    </div>
                    ${actionButtons}
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> スプレッドシート連携について</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">スプレッドシート連携により、実験結果が自動的にGoogleスプレッドシートに記録されます。</p>
                        <ul class="mb-2">
                            <li><strong>記録される情報:</strong> 実験設定、精度指標、Token使用統計、企業情報、実行時間、JSONファイル名など</li>
                            <li><strong>記録タイミング:</strong> 各シミュレーション完了時に自動記録</li>
                            <li><strong>データ形式:</strong> 個別結果のみを構造化された表形式で記録</li>
                            <li><strong>詳細情報:</strong> 詳細な面接記録はJSONファイルを参照</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function initializeSpreadsheet() {
            if (!confirm('スプレッドシートを初期化しますか？\n（ヘッダー行が設定されます）')) {
                return;
            }

            fetch('/api/spreadsheet/initialize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                } else {
                    alert(data.message);
                    loadSpreadsheetStatus();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('初期化に失敗しました');
            });
        }

        function clearSpreadsheetData() {
            if (!confirm('スプレッドシートのデータをクリアしますか？\n（ヘッダー行以外のすべてのデータが削除されます）\n\nこの操作は取り消せません。')) {
                return;
            }

            fetch('/api/spreadsheet/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                } else {
                    alert(data.message);
                    loadSpreadsheetStatus();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('データクリアに失敗しました');
            });
        }

        // ==================== 人間面接官モード機能 ====================
        
        // 人間面接官モードの初期化
        function initializeHumanInterviewer() {
            updateHumanInterviewFlowDisplay();
            
            // 面接フロータイプのラジオボタンの変更イベントを設定
            document.querySelectorAll('input[name="humanInterviewFlowType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const fixedFlowSettings = document.getElementById('humanFixedFlowSettings');
                    if (this.value === 'fixed') {
                        fixedFlowSettings.style.display = 'block';
                    } else {
                        fixedFlowSettings.style.display = 'none';
                    }
                });
            });
            
            // 人間面接開始ボタンのイベントリスナー
            document.getElementById('startHumanInterviewBtn').addEventListener('click', startHumanInterview);
            
            // 質問ボタンのイベントリスナー
            document.getElementById('askCommonQuestionBtn').addEventListener('click', askCommonQuestion);
            document.getElementById('askIndividualQuestionBtn').addEventListener('click', askIndividualQuestion);
            document.getElementById('askCustomQuestionBtn').addEventListener('click', askCustomQuestion);
            document.getElementById('endInterviewBtn').addEventListener('click', endHumanInterview);
        }

        // 人間面接フロー設定の関数
        function addHumanQuestionType(type) {
            humanInterviewFlow.push(type);
            updateHumanInterviewFlowDisplay();
        }

        function clearHumanInterviewFlow() {
            humanInterviewFlow = [];
            updateHumanInterviewFlowDisplay();
        }

        function updateHumanInterviewFlowDisplay() {
            const display = document.getElementById('humanInterviewFlowDisplay');
            const hiddenInput = document.getElementById('humanInterviewFlow');
            
            display.innerHTML = humanInterviewFlow.map((type, index) => {
                const badgeClass = type === 0 ? 'bg-success' : 'bg-primary';
                const text = type === 0 ? '全体' : '個別';
                return `<span class="badge ${badgeClass} me-1" title="質問${index + 1}">${text}</span>`;
            }).join('');
            
            hiddenInput.value = JSON.stringify(humanInterviewFlow);
        }

        // 人間面接を開始
        function startHumanInterview() {
            const setIndex = document.getElementById('humanSetIndex').value;
            const interviewFlowType = document.querySelector('input[name="humanInterviewFlowType"]:checked').value;
            
            let interviewFlow = null;
            let useDynamicFlow = false;
            
            if (interviewFlowType === 'fixed') {
                interviewFlow = JSON.parse(document.getElementById('humanInterviewFlow').value);
                useDynamicFlow = false;
            } else if (interviewFlowType === 'dynamic') {
                interviewFlow = null;
                useDynamicFlow = true;
            }
            
            fetch('/api/human_interview/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    set_index: setIndex || null,
                    interview_flow: interviewFlow,
                    use_dynamic_flow: useDynamicFlow
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                } else {
                    humanInterviewSession = data.session;
                    displayHumanInterviewSession(data);
                    updateHumanStatus('running', '面接中', 0, '面接セッションを開始しました');
                    document.getElementById('humanInterviewSession').style.display = 'block';
                    document.getElementById('startHumanInterviewBtn').disabled = true;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('人間面接の開始に失敗しました');
            });
        }

        // 人間面接セッションの表示
        function displayHumanInterviewSession(data) {
            const candidatesInfo = document.getElementById('humanCandidatesInfo');
            const interviewLog = document.getElementById('humanInterviewLog');
            
            // 候補者情報の表示
            candidatesInfo.innerHTML = data.candidates.map((candidate, index) => `
                <div class="card mb-2">
                    <div class="card-body p-2">
                        <h6 class="mb-1">候補者 ${index + 1}: ${candidate.name}</h6>
                        <small class="text-muted">
                            準備レベル: ${candidate.preparation}<br>
                            知識カバレッジ: ${candidate.knowledge_coverage}
                        </small>
                    </div>
                </div>
            `).join('');
            
            // 面接ログの初期化
            interviewLog.innerHTML = '<div class="text-muted text-center">面接を開始してください</div>';
        }

        // 全体質問を生成
        function askCommonQuestion() {
            if (!humanInterviewSession) return;
            
            fetch('/api/human_interview/ask_common_question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    session_id: humanInterviewSession.session_id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                } else {
                    displayQuestion(data.question, '全体質問');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('質問の生成に失敗しました');
            });
        }

        // 個別質問を生成
        function askIndividualQuestion() {
            if (!humanInterviewSession) return;
            
            fetch('/api/human_interview/ask_individual_question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    session_id: humanInterviewSession.session_id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                } else {
                    displayQuestion(data.question, '個別質問');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('質問の生成に失敗しました');
            });
        }

        // カスタム質問を送信
        function askCustomQuestion() {
            const question = document.getElementById('humanQuestionInput').value.trim();
            if (!question) {
                alert('質問を入力してください');
                return;
            }
            
            if (!humanInterviewSession) return;
            
            displayQuestion(question, 'カスタム質問');
            document.getElementById('humanQuestionInput').value = '';
        }

        // 質問を表示
        function displayQuestion(question, questionType) {
            const interviewLog = document.getElementById('humanInterviewLog');
            const timestamp = new Date().toLocaleTimeString();
            
            const questionElement = document.createElement('div');
            questionElement.className = 'log-entry mb-3';
            questionElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="badge ${questionType === '全体質問' ? 'bg-success' : questionType === '個別質問' ? 'bg-primary' : 'bg-secondary'}">${questionType}</span>
                    <small class="text-muted">${timestamp}</small>
                </div>
                <div class="bg-light p-3 rounded">
                    <strong>面接官:</strong> ${question}
                </div>
                <div class="mt-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="getStudentAnswer('${question.replace(/'/g, "\\'")}', '${questionType}')">
                        <i class="fas fa-reply"></i> 学生の回答を取得
                    </button>
                </div>
            `;
            
            interviewLog.appendChild(questionElement);
            interviewLog.scrollTop = interviewLog.scrollHeight;
        }

        // 学生の回答を取得
        function getStudentAnswer(question, questionType) {
            if (!humanInterviewSession) return;
            
            fetch('/api/human_interview/get_student_answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    session_id: humanInterviewSession.session_id,
                    question: question,
                    question_type: questionType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                } else {
                    displayStudentAnswer(data.answers);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('回答の取得に失敗しました');
            });
        }

        // 学生の回答を表示
        function displayStudentAnswer(answers) {
            const interviewLog = document.getElementById('humanInterviewLog');
            const timestamp = new Date().toLocaleTimeString();
            
            answers.forEach((answer, index) => {
                const answerElement = document.createElement('div');
                answerElement.className = 'log-entry mb-3';
                answerElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="badge bg-info">候補者 ${index + 1} の回答</span>
                        <small class="text-muted">${timestamp}</small>
                    </div>
                    <div class="bg-light p-3 rounded">
                        <strong>${answer.candidate_name}:</strong> ${answer.answer}
                    </div>
                `;
                
                interviewLog.appendChild(answerElement);
            });
            
            interviewLog.scrollTop = interviewLog.scrollHeight;
        }

        // 人間面接を終了
        function endHumanInterview() {
            if (!humanInterviewSession) return;
            
            if (!confirm('面接を終了しますか？')) return;
            
            fetch('/api/human_interview/end', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    session_id: humanInterviewSession.session_id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                } else {
                    displayHumanEvaluationResults(data.evaluation);
                    updateHumanStatus('completed', '完了', 100, '面接が完了しました');
                    document.getElementById('humanEvaluationResults').style.display = 'block';
                    document.getElementById('endInterviewBtn').disabled = true;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('面接の終了に失敗しました');
            });
        }

        // 人間面接の評価結果を表示
        function displayHumanEvaluationResults(evaluation) {
            const evaluationContent = document.getElementById('humanEvaluationContent');
            
            evaluationContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>評価結果</h6>
                        <div class="card">
                            <div class="card-body">
                                <h6>最も志望度が低い候補者</h6>
                                <div class="bg-light p-2 rounded mb-3">
                                    ${evaluation.least_motivated_candidate}
                                </div>
                                
                                <h6>候補者ランキング（志望度が低い順）</h6>
                                <div class="bg-light p-2 rounded">
                                    ${evaluation.motivation_ranking}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>面接統計</h6>
                        <div class="card">
                            <div class="card-body">
                                <ul class="list-unstyled">
                                    <li><strong>総質問数:</strong> ${evaluation.total_questions || 'N/A'}</li>
                                    <li><strong>全体質問数:</strong> ${evaluation.common_questions || 'N/A'}</li>
                                    <li><strong>個別質問数:</strong> ${evaluation.individual_questions || 'N/A'}</li>
                                    <li><strong>面接時間:</strong> ${evaluation.duration || 'N/A'}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 人間面接のステータス更新
        function updateHumanStatus(status, text, progress, step) {
            const statusIndicator = document.getElementById('humanStatusIndicator');
            const statusText = document.getElementById('humanStatusText');
            const progressBar = document.getElementById('humanProgressBar');
            const currentStep = document.getElementById('humanCurrentStep');
            
            if (status === 'running') {
                statusIndicator.className = 'status-indicator status-running';
            } else {
                statusIndicator.className = 'status-indicator status-idle';
            }
            
            statusText.textContent = text;
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
            currentStep.textContent = step;
        }

    </script>
</body>
</html>
