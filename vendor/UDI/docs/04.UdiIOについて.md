# UdiIOについて

## 概要
MDクライアントやDuelSimulatorとUniversal Duel Interface(以下UDI)を介して通信し、データの入出力をする機能をまとめたpythonのクラスです。
AI作成側はこれをimportして利用することでUDIとのやり取りをある程度簡便化/共通化出来ます。

また、UdiIOを使用するサンプルとして `udi_simple_v1.py` や `udi_random_v1.py` 等が用意してあります。

デュエルを進めるための基本の流れとしては

1. `UdiIO`のインスタンス(以下`udi_io`)を生成
2. `udi_io.input()`でUDIからデータを取得した後、`udi_io.get_commands()`で実行可能コマンドリストを取得
3. `udi_io.output_with_command_type()`でUDIにコマンドを送信
4. 2.に戻る

のようになります。

UDIからのデータの中身がudi_ioの各関数から取得できるので、その情報を使ってクライアントからの入力要求に返答を繰り返していきます。

## インスタンス生成時のオプションについて
UdiIO生成時に以下のオプションが指定できます。

| オプション        | 設定値                                       | デフォルト値 | 説明 |
|------------------|----------------------------------------------|--------------|------|
| `tcp_host`       | ホスト名の文字列                              | `127.0.0.1`  | 接続に使用するTCPホスト名を指定します。 |
| `tcp_port`       | `0 - 65535?`                                 | `8573` | 接続に使用するTCPポート番号を指定します。0を指定した場合は空いてるポートを自動的に割り当てます。 |
| `connect`        | `UdiIO.Connect.SOCKET`<br>`UdiIO.Connect.gRPC` | `UdiIO.Connect.SOCKET` | 接続に使用するモードを指定します。<br>**SOCKET** ... 生のSocket接続。クライアント側がMDクライアントの場合は必ずこちらを選択してください。<br>**GRPC** ... gRPC接続。クライアント側がDuel Simulatorの時のみ使用できます。大量/長時間に渡っての接続時はこちらの方が耐久性が高いようです。 |

## 情報取得メソッドについて
以下のメソッドでデュエル中にUDIから送られてくる`DuelData`を各データクラスなどで取得できます。

各データについてのpythonでの扱い方は`duel_data_sample.ipynb`の方に記載しています。

| メソッド名 | 説明 |
|--------|------|
| is_duel_start | 現在のデータがデュエル開始を表すかを返します。デュエル開始のタイミングでのみtrueになります。 |
| is_duel_end | 現在のデータがデュエル終了を表すかを返します。デュエル終了のタイミングでのみtrueになります。 |
| get_duel_end_data | デュエル終了時の情報を返します。デュエル終了時以外はNone。 |
| is_command_required | 入力要求が来ているかどうかを返します。 |
| get_command_request | 入力要求の情報CommandRequestを取得します。 |
| get_commands | CommandRequestのcommandsを取得します。 |
| get_command_log | CommandRequestの中にあるCommandLogを取得します。 |
| get_duel_log_data | 入力データからデュエルのログの情報DuelLogDataを取得。デュエル開始からのログ全て。 |
| get_new_duel_log_data | 入力データから新たに追加されたデュエルのログの情報を取得。 |
| get_duel_state_data | デュエルの現在の情報DuelStateDataを取得します。 |
| get_duel_card_table | DuelStateDataのカード毎の情報DuelCardTableを取得します。 |
| get_chain_stack | DuelStateDataのデュエル中のチェーンの情報ChainStackを取得 |

## 情報送信メソッドについて
UDIを通してクライアントに情報を送信するメソッドが用意されています。

コンテストでは`output_command`を使ってAIが選択したコマンドをクライアントに送信します。

| メソッド名 | 説明 |
|-----------|-----|
| output_command | AIエージェントが選択したコマンドのcommands内のインデックスを送信します。返答形式はCommandRequestのcommands内のindexです。 |
| output_optional_data | オプションのデータを送信します |
| output_guess_set_card | セットカード予測データを送信します |
| output_rating_text | 評価値テキストデータを送信します |
| output_situation_score | 形勢評価スコアを送信します |

## ログ保存メソッドについて
UDIからの入力とAIエージェントが選択したコマンドを`UdiLogData`という形式で保存する機能があります。

この形式で保存したログはGUIで読み込んで確認できます。

### 形式
UdiLogDataはUDIからの入力とAIエージェントが選択したコマンドからなります。

```
@dataclass
class UdiLogData:
    """
    udi_ioのログの保存フォーマット
    """
    command_request :CommandRequest
    duel_state_data :DuelStateData
    duel_log_data :list[DuelLogDataEntry]
    selected_command :int
```

### 関連するメソッド
| メソッド名 | 説明 |
|-----------|------|
| start_udi_logging | ログの記録を開始します。以降、ログはバッファに蓄積されます。 |
| flush_udi_logs | バッファのログをファイルに出力します。 |

※`start_udi_logging`を呼び出した後は、`flush_udi_logs`で任意のタイミングでバッファを出力できますが、ログが溜まりすぎるのを防ぐために、10デュエル分のログが蓄積された時点で`flush_udi_logs`が自動的に呼び出され、ログが強制的にファイル出力されます。